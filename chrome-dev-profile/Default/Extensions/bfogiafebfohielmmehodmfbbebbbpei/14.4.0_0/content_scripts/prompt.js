const KeeperPromptManager=new class{constructor(){this.currentUrl=location.origin+location.pathname,this.hasPrompted=!1,this._finished=!0,this._attemptTimeout=null,this.blacklist=[/advertisercommunity\.com/],this.multipromptWhitelist=[/accounts\.google\.com/,/login\.live\.com/,/walgreens\.com\/login/,/upwork\.com\/ab\/account-security\/login/,/idmsa\.apple\.com\/appleauth\/auth\/signin/],this.singleFieldWhitelist=[/lynda\.com\/signin/,/accounts\.google\.com/,/login\.yahoo\.com/,/signin\.ebay\.com/,/login\.live\.com/,/login\.skype\.com/,/signin\.webex\.com/,/login\.verizonwireless\.com/,/idaas\.iam\.ibm\.com/,/account\.docusign\.com/,/auth\.uber\.com/,/amazon\.com\/ap\/signin/,/service\.ringcentral\.com/,/upwork\.com\/ab\/account-security\/login/,/onlinebanking\.usbank\.com\/Auth\/Login/,/walgreens\.com\/login/,/idmsa\.apple\.com\/appleauth\/auth\/signin/,/www\.paypal\.com\/us\/signin/]}get lastAttemptFinished(){return this._finished}set lastAttemptFinished(e){e||(clearTimeout(this._attemptTimeout),this._attemptTimeout=setTimeout(()=>{this._finished=!0,this._attemptTimeout=null},1e4)),this._finished=e}showPrompt(e){const{lock:t,onResponse:o}=e;this.hasPrompted=!0,t&&t.style&&(t.style.opacity="1");var r={lockId:t?t.id:null,lockBounds:t?getBoundingClientRect(t):null,frameSrc:inFrame?document.location.href:null};sendMessage("openFrame",{type:"ACTION",data:{name:"openFrame",lockId:t?t.id:null}},function(t){e.registrationRetry&&(getKeeperPositionablePopup().registrationRetry=!0),e.referrer=ourUrl.hostname||ourUrl.pathname,e.faviconUrl=getFaviconUrl(),o?sendMessage("showPromptFromFrame",{type:"ACTION",data:Object.assign(r,{props:e,wantResponse:!0})},e=>{e&&o.call({refs:{disable:{checked:e.shouldDisable},recordSelector:{record:e.record}}},{target:e.target})}):sendMessage("showPromptFromFrame",{type:"ACTION",data:Object.assign(r,{props:e})})})}canPrompt(e,...t){return!!e&&(!(!this.singleFieldWhitelist.some(o)&&!Array.from(e.elems).some(([e])=>KeeperFill.isPassword(e))||inFrame&&!isElementRendered(document.body)||this.blacklist.some(o))&&(this.hasPrompted?!!this.multipromptWhitelist.some(o):t.every(Boolean)));function o(e){return"string"==typeof e?e===location.href:e.test(location.href)}}tryToPrompt(){isConsoleForPrompt()||sendMessage("settings",{type:"GET"},function(e){isKeeper()||e&&e.hasOwnProperty&&e.hasOwnProperty("showLocks")&&!e.showLocks||KeeperFill.detectBestGroups().then(e=>{sendMessage("try_to_prompt_data",{type:"GET"},t=>{var{settings:o,isLoggedIn:r}=t;if(e.loginGroup&&safariAPI&&o.savePrompt){var s=Array.from(e.loginGroup.elems),n=KeeperFill.utils.detectSubmitButton(s),i=null;n&&!i&&(i=n.addEventListener("click",function(e){e.target.removeEventListener("click",i),saveInputValues()}))}if(Object.values(e).reduce((e,t)=>e||null!==t,!1)){let t=null;!r&&o.loginPrompt?KeeperPromptManager.tryLoginPrompt(e):r&&getRecordClickedInVault(function(r){if(r&&r.autoFillRecord&&!r.doNotFillForATime){KeeperPromptManager.hasPrompted=!0;var s={payload:r.autoFillRecord,displayMode:"record"};autoFill(s,function(e){})}else r&&r&&r.tabId||!r||r.doNotFillForATime?KeeperPromptManager.hasPrompted=!0:sendMessage("records",{type:"GET",data:{referrer:ourUrl}},function(r){o.changePrompt&&e.changepasswordGroup&&r.length>0?(t="tryChangePrompt")&&KeeperPromptManager[t](e,r):!o.fillPrompt||!e.loginGroup&&!e.registrationGroup||e.cardGroup||e.addressGroup||(1===r.length&&r[0].non_shared_data&&"always"===r[0].non_shared_data.auto_fill_mode?sendMessage("giveRecordTotpInCustomForFilling",{type:"ACTION",data:r[0]},function(t){KeeperPromptManager.tryAutoFill(e,[t])}):KeeperPromptManager.tryFillPrompt(e,r))})})}})}).catch(e=>{console.error(e)})})}tryAutoFill({changepasswordGroup:e,loginGroup:t,registrationGroup:o},r,s=!1){if(e)return!1;if(!t&&!o)return!1;if(!r||1!==r.length)return!1;var n=r[0],i=pickGroup({loginGroup:t,registrationGroup:o}),a=this;getLastLogOutTime().then(e=>{return e+1e4<Date.now()?sendMessage("lastFillTimeOnInputField",{type:"GET",data:{record:n}},function(e){if(s){if(a.canPrompt(i))return smartFill(n,i)}else{const t=n.non_shared_data&&"always"===n.non_shared_data.auto_fill_mode;if(a.canPrompt(i,t))return a.hasPrompted=!0,smartFill(n,i,e)}}):a.hasPrompted=!0,!1})}tryLoginPrompt({changepasswordGroup:e,loginGroup:t,registrationGroup:o}){const r=getFirstLock(e,t,o);if(!this.hasPrompted&&r)return this.hasPrompted=!0,this.showPrompt({lock:r,message:translateThis("extension_prompt_to_login")})}tryFillPrompt({loginGroup:e,registrationGroup:t},o){if((t||!o||0!==o.length)&&!this.hasPrompted&&isElementRendered(document.body)){if(KeeperFill.history.length){e&&e.elems.has(KeeperFill.history[0].elems[0]),t&&t.elems.has(KeeperFill.history[0].elems[0])}if(o&&o.length&&this.canPrompt(e||t)){const n=getFirstLock(e||t),i=o[0];if(1===o.length&&i.secret1&&i.secret2)this.showPrompt({lock:n,message:translateThis("extension_prompt_to_fill"),settingNameToToggle:"fillPrompt",firstRecord:i,loginGroup:e,onResponse(t){"confirm"===t.target.id&&sendMessage("updateNonSharedData",{type:"SET",data:{recordUid:i.record_uid,changes:{auto_fill_mode:"confirm"===t.target.id?"always":"never"}}},function(t){smartFill(t,e)})}});else if(e&&1===e.elems.size&&KeeperFill.isPassword(Array.from(e.elems)[0][0])){var r=Array.prototype.slice.call(e.ancestor.querySelectorAll('input[type="hidden"], input[type="email"]')).filter(e=>KeeperFill.isLogin(e)&&""!==e.value),s=o.find(e=>r.some(t=>t.value===e.secret1));s?(this.hasPrompted=!0,getLastLogOutTime().then(t=>{t+1e4<Date.now()&&sendMessage("lastFillTimeOnInputField",{type:"GET",data:{record:s}},function(t){smartFill(s,e,t)})})):sendMessage("isNotAppendedToLock",{type:"GET"},function(e){showLoggedInKeeper(n,!0,null,null,null,null,!e)})}else sendMessage("isNotAppendedToLock",{type:"GET"},function(e){showLoggedInKeeper(n,!0,null,null,null,null,!e)})}else this.canPrompt(t)?sendMessage("isNotAppendedToLock",{type:"GET"},function(e){showLoggedInKeeper(getFirstLock(t),!0,null,null,null,null,!e)}):this.canPrompt(e)&&sendMessage("isNotAppendedToLock",{type:"GET"},function(t){showLoggedInKeeper(getFirstLock(e),!0,null,null,null,null,!t)})}}trySavePrompt(e){var{promptableLoginData:t,loginMatchingRecords:o=[]}=e;if(t){const e=t.record_uid&&o.find(e=>t.record_uid===e.record_uid)||{};this.showPrompt({closeOnConfirm:!1,message:e.record_uid?translateThis("prompt_to_update"):translateThis("save_password_prompt"),settingNameToToggle:"savePrompt",promptableLoginData:t,existingRecord:e,onResponse(o){"confirm"===o.target.id&&sendMessage("showSaveOptions",{type:"ACTION",data:{promptableLoginData:t,existingRecord:e}})}})}}tryReRegistration(e){var t=e;sendMessage("isLoggedIn",{type:"GET"},e=>{if(e&&t){this.showPrompt({closeOnConfirm:!1,message:"It seems that the username was taken. Would you like to edit your record and try another username for this site?",settingNameToToggle:"reregistration",overwriteHasPrompted:!0,registrationRetry:!0,payload:!0,record:t,onResponse(e){"confirm"==e.target.id&&sendMessage("editMode",{type:"ACTION",data:{payload:!0,record:t}})}})}})}tryChangePrompt({changepasswordGroup:e},t){var o=t.filter(e=>e.can_edit);if((o=o.filter(function(e){return!!(e&&e.secret2&&e.secret2.length&&e.secret2.length>0)})).length>0&&this.canPrompt(e,t)){var r=this;sendMessage("changePasswordPending",{type:"GET"},function(t){t?r.hasPrompted=!0:r.showPrompt({records:o,lock:getFirstLock(e),message:translateThis("change_your_password2","Would you like Keeper to help you change your password?"),settingNameToToggle:"changePrompt",closeOnConfirm:!1,onResponse(e){"confirm"===e.target.id&&sendMessage("changePasswordFlow",{type:"ACTION"})}})})}}};function getFirstLock(...e){const t=e.filter(Boolean)[0];let o=null;if(t){const e=Array.from(t.elems).find(([e])=>isElementInView(e));o=e?e[0].parentNode.querySelector("keeper-lock"):null}return o||(o=document.querySelector("keeper-lock")),o}function showRevertScreen(e){sendMessage("openFrame",{type:"ACTION",data:{name:"openFrame",lockId:null}},function(t){var o={};o.record=e.record_uid,getKeeperPositionablePopup().querySelector("keeper-iconbutton-close").addEventListener("click",function(e){sendMessage("changePasswordPending",{type:"SET",data:null},function(e){sendMessage("restoreLocks",{type:"ACTION"}),sendMessage("closeFrame",{type:"ACTION"})})}),o.referrer=ourUrl.hostname||ourUrl.pathname,o.faviconUrl=getFaviconUrl(),KeeperPromptManager.hasPrompted=!0,sendMessage("checkChangedPassword",{type:"ACTION",data:{props:o}})})}function isConsoleForPrompt(){return 0===location.pathname.indexOf("/console/")&&(location.hostname.indexOf("keepersecurity.com")===location.hostname.length-18||(location.hostname.indexOf("keepersecurity.eu")===location.hostname.length-17||"localhost"===location.hostname))}function getFieldsInPickedGroup(e,t){if(e){var o=[];return Array.from(e.elems).forEach(e=>{KeeperFill.utils.isLogin(e[0])||KeeperFill.utils.isRegistration(e[0])?o.push("username"):KeeperFill.utils.isPassword(e[0])?o.push("password"):t.custom&&t.custom.forEach(e=>{o.push(e.name)})}),o}}