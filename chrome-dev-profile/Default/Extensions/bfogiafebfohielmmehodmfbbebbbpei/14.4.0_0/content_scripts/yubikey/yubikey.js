const postMessage=e=>{window.postMessage({...e,client:"ext"},document.location.origin)},postSecureWindowMessage=e=>{sendMessage("postSecureWindowMessage",{type:"ACTION",messageData:e,communication_key:communication_key},e=>{e=convert.object_to_uint8array(e),window.postMessage({response:e,client:"ext"},document.location.origin)})},rsaKey=new RSAKey;let communication_key;var supportsClosingTabs=!0;function handleEncryptedMessage(e){switch(e.sentMessageId){case"ping":const{client:s}=e;"ext"!==s&&console.log("extension pong:",e);break;case"yubikey_u2f_challenge":sendMessage("yubikey_u2f_challenge",{type:"GET"},function(e){chooseCorrectExpOption(e.expireToken);var s=e.u2f_challenge&&e.u2f_challenge.enforcements&&e.u2f_challenge.enforcements.two_factor_duration_web;if(s){var n=document.querySelectorAll(".selection-dropdown-list-item");Array.prototype.forEach.call(n,function(e){-1===s.indexOf(e.getAttribute("days"))&&e.remove()})}e.u2f_challenge.sentMessageId="authenticateRequests",postSecureWindowMessage(e.u2f_challenge)});break;case"u2fchallenge":delete e.client,delete e.sentMessageId,sendMessage("loginThroughYubikey",{type:"ACTION",data:e},function(e){"success"===e?safariAPI&&!supportsClosingTabs?postMessage({sentMessageId:"loginSuccess"}):sendMessage("closeTab",{type:"ACTION"}):console.log("Authentication of Security Key did not work here.")});break;case"yubikeyDuoSelection":delete e.sentMessageId,sendMessage("yubikeyDuoSelection",{type:"ACTION",data:e});break;case"yubikey2faLogin":delete e.sentMessageId,sendMessage("yubikey2faLogin",{type:"ACTION",data:e},function(e){"success"===e?safariAPI&&!supportsClosingTabs?postMessage({sentMessageId:"loginSuccess"}):sendMessage("closeTab",{type:"ACTION"}):postSecureWindowMessage({sentMessageId:"showSecondary2faError"})})}}function handleUnencryptedMessage(e){switch(e.sentMessageId){case"handshake":sendMessage("handshake",{type:"ACTION"},e=>{var s=e.public_key,n=e.private_key;rsaKey.readPKCS5PrvKeyHex(n),postMessage({sentMessageId:"public-key",public_key:s})});break;case"communication-key":const{communication_key:s}=e,n=rsaKey.decryptBinary(s);sendMessage("communication_key",{type:"ACTION",temp_communication_key_hex:n},e=>{communication_key=e.commKey,postSecureWindowMessage({sentMessageId:"handshake-complete"})})}}function chooseCorrectExpOption(e){var s="";switch(e){case 0:s=translateThis("Require_every_login");break;case 30:s=translateThis("Require_every_30_days");break;case 9999:s=translateThis("Save_code__forever")}var n=document.getElementById("requirecodedropdown"),t=document.getElementById("dropdown-arrow");n.textContent=s,n.append(t)}safariAPI&&(addMessageListener(handleResponse),supportsClosingTabs=function(){const e=navigator.userAgent.match(/version\/(\d+(\.\d+)+)/i);if(e){const s=e[1].split("."),n=Number(s[0]),t=Number(s[1]);return n>12||12===n&&t>=1}return!1}()),window.addEventListener("message",function(e){var s=e.data;e.origin,e.source;if("ext"!==s.client){document.location.origin?document.location.origin:(window.location.protocol,window.location.hostname,window.location.port&&window.location.port);s instanceof Uint8Array||!s.sentMessageId?(isFirefox&&(s=Uint8Array.from(s)),sendMessage("encrypted_message",{type:"ACTION",data:s,communication_key:communication_key},e=>{handleEncryptedMessage(e)})):handleUnencryptedMessage(s)}});