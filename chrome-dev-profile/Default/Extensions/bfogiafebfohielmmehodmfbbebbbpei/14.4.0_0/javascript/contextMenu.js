function createBasicContextMenu(e,t,n,r,a){t?chrome.contextMenus.create({id:e,parentId:t,title:n,contexts:["editable"],onclick:r},a):chrome.contextMenus.create({id:e,title:n,contexts:["editable"],onclick:r},a)}function createDisabledContextItem(e,t,n){chrome.contextMenus.create({id:e,parentId:t,title:n,enabled:!1,contexts:["editable"]},()=>{})}function createSeparatorContextMenu(e){chrome.contextMenus.create({type:"separator",parentId:e,contexts:["editable"]},()=>{})}function createFullContextMenu(e){removeContextMenu();try{makeContextMenu()}catch(e){logger({data:"There was an error making the context menu",whichMessages:{contextMenuMessages:!0},consoleFunction:console.error})}}function removeContextMenu(){try{chrome.contextMenus.removeAll()}catch(e){logger({data:"trying to remove menu item: "+e,whichMessages:{contextMenuMessages:!0},consoleFunction:console.log})}}function updateContextMenu(e){removeContextMenu();try{makeContextMenu(e)}catch(e){logger({data:"There was an error making the context menu",whichMessages:{contextMenuMessages:!0},consoleFunction:console.error})}}function openExtensionWindow(){var e=bg.get("lastInputField");sendMessage("showLoggedInKeeper",{input:e?e.readyInput:null,fromContextMenu:!0})}function launchVaultFromContextMenu(){openVaultContextMenu()}function logoutFromContextMenu(e){Logout()}function makeContextMenu(e){removeContextMenu();var t=bg.get("enforcements"),n=e||bg.get("currentUrl");t&&t.restrict_domain_access&&verifyDomainEnforcement(n,t.restrict_domain_access.split(","))||createBasicContextMenu("KeeperFill_Extension_Start",null,"Keeper",()=>{},()=>{if(n){var e=getUrlMatchedRecords(n);createContextMenuItems(e,"record"),e.length>0&&createSeparatorContextMenu("KeeperFill_Extension_Start")}createBasicContextMenu("KeeperFill_Extension_Payments","KeeperFill_Extension_Start",translateThis("payment_card"),()=>{},()=>{bg.getCacheProp("profile.cards")&&createContextMenuItems(bg.getCacheProp("profile.cards").concat(),"card")}),createBasicContextMenu("KeeperFill_Extension_Addresses","KeeperFill_Extension_Start",translateThis("Addresses"),()=>{},()=>{bg.getCacheProp("profile.addresses")&&createContextMenuItems(bg.getCacheProp("profile.addresses").concat(),"address")}),createSeparatorContextMenu("KeeperFill_Extension_Start"),createBasicContextMenu("KeeperFill_Extension_Create_New","KeeperFill_Extension_Start",translateThis("create_new"),()=>{},()=>{createContextMenuCreateItems()}),createSeparatorContextMenu("KeeperFill_Extension_Start"),createBasicContextMenu("KeeperFill_Extension_Open","KeeperFill_Extension_Start",translateThis("open_extension"),openExtensionWindow,()=>{}),createBasicContextMenu("KeeperFill_Extension_Vault","KeeperFill_Extension_Start",translateThis("launch_vault"),launchVaultFromContextMenu,()=>{}),createSeparatorContextMenu("KeeperFill_Extension_Start"),createBasicContextMenu("KeeperFill_Extension_Logout","KeeperFill_Extension_Start",translateThis("logout_of_username").replace("XXX",bg.get("uname")),logoutFromContextMenu,()=>{})})}function createContextMenuCreateItems(){createBasicContextMenu("KeeperFill_Extension_Create_Record","KeeperFill_Extension_Create_New",translateThis("record_header"),openCreateEditMenu("record",!1)),createBasicContextMenu("KeeperFill_Extension_Create_Payment_Card","KeeperFill_Extension_Create_New",translateThis("payment_card"),openCreateEditMenu("card",!1)),createBasicContextMenu("KeeperFill_Extension_Create_Address","KeeperFill_Extension_Create_New",translateThis("contact.address"),openCreateEditMenu("address",!1))}function openCreateEditMenu(e,t,n){return function(r){var a=bg.get("lastInputField");sendMessage("showLoggedInKeeper",{fromContextMenu:!0,input:a?a.readyInput:null},null,function(r){t?sendMessage("openCreateEditMenu",{itemType:e,edit:{data:n,isEdit:t}},null,null,!0):sendMessage("openCreateEditMenu",{itemType:e},null,null,!0)},!0)}}function setChangedUrl(e){var t;try{t=new URL(e)}catch(t){return bg.set("currentUrl",e),void removeContextMenu()}t.origin!=bg.get("currentUrl")&&(bg.set("currentUrl",t.origin),t.host&&t.host.includes(".")?bg.get("isLoggedIn")&&updateContextMenu(t.host):removeContextMenu())}function updateRecordContextMenuList(e){}function updateCardContextMenuList(){}function updateAddressContextMenuList(){}function openEditMenu(e,t){sendMessage("showLoggedInKeeper",{fromContextMenu:!0},null,function(){sendMessage("editItemFromContextMenu",{type:e,item:t})},!0)}function createRecordContextMenuItem(e,t){var n=e.record_uid?e.record_uid:"",r=e.title?e.title:"",a=e.secret1?e.secret1:"";e.secret2&&e.secret2,e.url&&e.url;createBasicContextMenu(n,"KeeperFill_Extension_Start",r,()=>{},()=>{createDisabledContextItem(n+"disabled_title",n,a),createBasicContextMenu(n+"fill",n,translateThis("fill_record"),smartFillRecordFromContextMenu("records")),createSeparatorContextMenu(n),e.can_edit&&(createBasicContextMenu(n+"edit",n,translateThis("Edit_Record"),openCreateEditMenu("record",!0,e)),createSeparatorContextMenu(n)),createBasicContextMenu(n+"secret1",n,translateThis("fill_emailusername"),fillContextMenuItem("records")),createBasicContextMenu(n+"secret2",n,translateThis("Fill_Password"),fillContextMenuItem("records"));const t=e.extra&&e.extra.fields||[];t.length>0&&t.forEach((e,t)=>{"totp"===e.field_type&&createTotpExtraContextMenuItem(e,n,t)}),e.custom&&e.custom.length>0&&e.custom.forEach((e,t)=>{createCustomFieldContextMenuItem(e,n,t)})})}function createCustomFieldContextMenuItem(e,t,n){var r=n?t+n:t,a=r+JSON.stringify(e);createBasicContextMenu(a,t,e.name,()=>{},()=>{var o=bg.get("enforcements");createDisabledContextItem(r+e.name+"name",a,e.name),/password/i.test(e.name)||o&&o.mask_custom_fields?createBasicContextMenu(r+e.value+"value",a,"••••••••••",fillContextMenuItemCustom(t,n)):createBasicContextMenu(r+e.value+"value",a,e.value,fillContextMenuItemCustom(t,n))})}function createTotpExtraContextMenuItem(e,t,n){var r=n?t+n:t,a=r+JSON.stringify(e),o=e.field_title||translateThis("two_factor_code");createBasicContextMenu(a,t,o,()=>{},()=>{createDisabledContextItem(r+e.id+"name",a,o);var s=e.data.indexOf("digits=6")>0?"••••••":"••••••••";createBasicContextMenu(r+e.value+"value",a,s,fillContextMenuItemTotp(t,n))})}function createCardContextMenuItem(e,t){var n=e.uid?e.uid:"",r=e.ccn?e.ccn:"",a=(e.ccv&&e.ccv,e.expiration&&e.expiration,e.name_on_card&&e.name_on_card,e.title?e.title:""),o=cardValidator.number(e.ccn),s=o&&o.card&&o.card.niceType?o.card.niceType+" ":" ";createBasicContextMenu(n,"KeeperFill_Extension_Payments",a,()=>{},()=>{var t=r?r.length>3?r.substring(r.length-4,r.length):r:"";createDisabledContextItem(n+"disabled_title",n,translateThis("cardname_ending_in_cardnumber").replace("XXX",s).replace("YYY",t)),createBasicContextMenu(n+"fill",n,translateThis("fill_card"),smartFillRecordFromContextMenu("cards")),createSeparatorContextMenu(n),createBasicContextMenu(n+"edit",n,translateThis("edit_card"),openCreateEditMenu("card",!0,e)),createSeparatorContextMenu(n),createBasicContextMenu(n+"ccn",n,translateThis("fill_card_number"),fillContextMenuItem("cards")),createBasicContextMenu(n+"expiration",n,translateThis("fill_expiration_date"),fillContextMenuItem("cards")),createBasicContextMenu(n+"ccv",n,translateThis("fill_cvv"),fillContextMenuItem("cards")),createBasicContextMenu(n+"name_on_card",n,translateThis("fill_name_on_card"),fillContextMenuItem("cards"))})}function createAddressContextMenuItem(e,t){var n=e.uid?e.uid:"",r=(e.city&&e.city,e.email&&e.email,e.first_name&&e.first_name,e.last_name&&e.last_name,e.phone&&e.phone,e.state&&e.state,e.street_address&&e.street_address[0]?e.street_address[0]:""),a=e.street_address&&e.street_address[1]?e.street_address[1]:"",o=e.title?e.title:"";e.zip&&e.zip;createBasicContextMenu(n,"KeeperFill_Extension_Addresses",o,()=>{},()=>{createDisabledContextItem(n+"disabled_title",n,r+" "+a),createBasicContextMenu(n+"fill",n,translateThis("fill_address"),smartFillRecordFromContextMenu("addresses")),createSeparatorContextMenu(n),createBasicContextMenu(n+"edit",n,translateThis("edit_address"),openCreateEditMenu("address",!0,e)),createSeparatorContextMenu(n),createBasicContextMenu(n+"street_address_one",n,translateThis("fill_street_address_line_one"),fillContextMenuItem("addresses")),createBasicContextMenu(n+"street_address_two",n,translateThis("fill_street_address_line_two"),fillContextMenuItem("addresses")),createBasicContextMenu(n+"city",n,translateThis("fill_city"),fillContextMenuItem("addresses")),createBasicContextMenu(n+"state",n,translateThis("fill_state"),fillContextMenuItem("addresses")),createBasicContextMenu(n+"zip",n,translateThis("fill_zip_postal_code"),fillContextMenuItem("addresses")),createBasicContextMenu(n+"first_name",n,translateThis("fill_first_name"),fillContextMenuItem("addresses")),createBasicContextMenu(n+"last_name",n,translateThis("fill_last_name"),fillContextMenuItem("addresses")),createBasicContextMenu(n+"email",n,translateThis("fill_email_address"),fillContextMenuItem("addresses")),createBasicContextMenu(n+"phone",n,translateThis("fill_phone_number"),fillContextMenuItem("addresses"))})}function fillContextMenuItem(e){return function(t){var n,r,a=bg.get("lastInputField"),o=a?a.readyInput:null,s=a?a.frameUrl:null,i=a?a.pageUrl:null,l=JSON.parse(o);if("street_address_one"==t.menuItemId.replace(t.parentMenuItemId,""))n=bg.getCacheProp("addresses."+t.parentMenuItemId).street_address[0];else if("street_address_two"==t.menuItemId.replace(t.parentMenuItemId,""))n=bg.getCacheProp("addresses."+t.parentMenuItemId).street_address[1];else if("phone"==t.menuItemId.replace(t.parentMenuItemId,"")){var c=bg.getCacheProp("phones")[bg.getCacheProp(e+"."+t.parentMenuItemId)[t.menuItemId.replace(t.parentMenuItemId,"")]];n=(c.country_code||"")+(c.phone_number||"")}else r=bg.getCacheProp(e+"."+t.parentMenuItemId),n=r[t.menuItemId.replace(t.parentMenuItemId,"")];var u=!0;if("record"===e&&getRecordsAsArray().forEach(n=>{bg.getCacheProp(e+"."+t.parentMenuItemId).record_uid===n.record_uid&&(u=n.can_view)}),"secret2"!==t.menuItemId.replace(t.parentMenuItemId,"")||u||!l||l.type&&"password"===l.type){function d(){sendMessage("contextMenuIndividualFill",{inputField:o,payload:n||""})}i&&"http:"===getProtocol(i)?confirmFromIframe(translateThis("autofill_fill_http").replace("XXX",i),null,o,function(e){e&&d()}):isTopWindowURLTheFrameURL(s,i)?d():confirmFromIframe(translateThis("individual_fill_cross_domain").replace("XXX",r.link).replace("YYY",s),null,o,function(e){e&&d()})}}}function fillContextMenuItemCustom(e,t){return function(n){var r=bg.get("lastInputField"),a=r?r.readyInput:null,o=r?r.frameUrl:null,s=r?r.pageUrl:null,i=bg.getCacheProp("records."+e),l=i.custom;if(l){var c=l[t].value;if(c){function u(){sendMessage("contextMenuIndividualFill",{inputField:a,payload:c})}s&&"http:"===getProtocol(s)?confirmFromIframe(translateThis("autofill_fill_http").replace("XXX",s),null,a,function(e){e&&u()}):isTopWindowURLTheFrameURL(o,s)?u():confirmFromIframe(translateThis("individual_fill_cross_domain").replace("XXX",i.link).replace("YYY",o),null,a,function(e){e&&u()})}}}}function fillContextMenuItemTotp(e,t){return function(n){var r=bg.get("lastInputField"),a=r?r.readyInput:null,o=r?r.frameUrl:null,s=r?r.pageUrl:null,i=bg.getCacheProp("records."+e),l=i.extra&&i.extra.fields?i.extra.fields[t]:"";if(l){var c=l.data,u=generateTotpToken(generateTotpParams(c));if(u){function d(){sendMessage("contextMenuIndividualFill",{inputField:a,payload:u})}s&&"http:"===getProtocol(s)?confirmFromIframe(translateThis("autofill_fill_http").replace("XXX",s),null,a,function(e){e&&d()}):isTopWindowURLTheFrameURL(o,s)?d():confirmFromIframe(translateThis("individual_fill_cross_domain").replace("XXX",i.link).replace("YYY",o),null,a,function(e){e&&d()})}}}}function smartFillRecordFromContextMenu(e){return function(t){const n=t.parentMenuItemId,r=getDataById(n);r.link=r.link||t.pageUrl,autoFill({payload:r,displayMode:"records"==e?"record":"cards"==e?"card":"address"})}}function createContextMenuItems(e,t){var n,r,a=_.cloneDeep(e);switch(t){case"record":n=createRecordContextMenuItem;break;case"card":r="KeeperFill_Extension_Payments",n=createCardContextMenuItem;break;case"address":r="KeeperFill_Extension_Addresses",n=createAddressContextMenuItem}a.length<=0?r&&chrome.contextMenus.remove(r):a.length<5&&n?a.splice(0,a.length).forEach(n):n&&a.splice(0,5).forEach(n)}function verifyDomainEnforcement(e,t){for(var n="",r=0;r<t.length;r++)if(n=t[r].replace(/\*/g,"(?:.*)"),locationTester(e,new RegExp(n,"i")))return!0;return!1}function locationTester(e,t){var n=e||bg.get("currentUrl");try{var r=new URL(bg.get("currentUrl"));return t.test(r.origin+r.pathname)}catch(e){return!!n&&t.test(n)}}"undefined"!=typeof browser&&(chrome=browser);