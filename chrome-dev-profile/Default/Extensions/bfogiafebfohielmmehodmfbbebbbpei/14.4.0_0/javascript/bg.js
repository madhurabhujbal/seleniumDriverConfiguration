var API_COMMANDS={GET_DEVICE_TOKEN:"get_device_token",PRE_LOGIN:"pre_login",MASTER_PASSWORD_REENTRY_ACTION_TYPE:"validate_master_password"};const{ApiRequest:ApiRequest,ApiRequestPayload:ApiRequestPayload,AuthRequest:AuthRequest,DeviceRequest:DeviceRequest,DeviceResponse:DeviceResponse,LoginType:LoginType,NewUserMinimumParams:NewUserMinimumParams,PreLoginRequest:PreLoginRequest,PreLoginResponse:PreLoginResponse,MasterPasswordReentryActionType:MasterPasswordReentryActionType,MasterPasswordReentryRequest:MasterPasswordReentryRequest,UidRequest:UidRequest,UserAuthRequest:UserAuthRequest}=protobuf.Authentication;var logintype=null,globalBG={offlineDBUsers:{}},bg={autoFillRecord:void 0,auth_queue:[],authExpired:!1,masterPasswordExpired:!1,uname:null,pass:null,deviceToken:null,sessionToken:null,doNotPrompt:{},toolbarIconInterval:0,encryptionKey:null,rsaPrivateKey:null,encryption_params:null,encrypted_data_key:null,encrypted_private_key:null,account_settings:null,license:null,enforcements:null,is_enterprise_admin:!1,error:!1,disabledSites:[],vaultRecordClickedTimeout:null,lastRecordClicked:null,lastFilledFieldsByRecord:{},authSalt:null,authIterations:null,device_token_expire_days:9999,suppressPasswordsChanged:null,isLoggedIn:!1,isPendingU2F:!1,rememberMe:!1,u2fTabId:null,remoteTerms:null,remotePrivacy:null,termsWasClicked:null,privacyWasClicked:null,deviceId:"ext",inactivity_timeout:null,inactivity_settime:0,autoFilledOnce:!1,sso_security_provider_url:null,promptableLoginData:null,tryCustomFillRecord:null,clickedLock:"",clientId:CryptoJS.lib.WordArray.random(16).toString(CryptoJS.enc.URLBase64),lastLogOutTimes:"",prompt_disabled_tabs:[],isSsoUser:!1,whichTabIsHighlighted:"",lastInputField:null,currentUrl:"",vault_comm_keys_by_tab:{},vault_logged_in_by_tab:{},vault_port_by_tab:{},vault_priv_keys_by_tab:{},yubikey_u2f_challenge:"",temp_login:"",temp_password:"",masterPasswordReEntryRecord:{},masterPasswordReEntryCase:!1,MPReentryEnabled:!1,MPReentryTestValue:void 0,MPReentryTime:0,cache:null,PUBLIC_KEY_ID:1};function appendBGFunctions(e){e.delete=function(e){return _.unset(this,e)},e.deleteCacheProp=function(e){return _.unset(this,`cache.${e}`)},e.get=function(...e){var t={};if(e.length>1)for(var n=0;n<e.length;n++)t[e[n]]=_.get(this,e[n]);else t=_.get(this,e[0]);return t},e.getCache=function(){return _.get(this,"cache")},e.getCacheProp=function(e){return _.get(this,`cache.${e}`,null)},e.set=function(e,t){_.set(this,e,t)},e.setCacheProp=function(e,t){_.set(this,`cache.${e}`,t)},e.URLSafeBase64PublicStrings={1:"MIIBCgKCAQEA9Z_CZzxiNUz8-npqI4V10-zW3AL7-M4UQDdd_17759Xzm0MOEfHOOsOgZxxNK1DEsbyCTCE05fd3Hz1mn1uGjXvm5HnN2mL_3TOVxyLU6VwH9EDInnj4DNMFifs69il3KlviT3llRgPCcjF4xrF8d4SR0_N3eqS1f9CBJPNEKEH-am5Xb_FqAlOUoXkILF0UYxA_jNLoWBSq-1W58e4xDI0p0GuP0lN8f97HBtfB7ijbtF-VxIXtxRy-4jA49zK-CQrGmWqIm5DzZcBvUtVGZ3UXd6LeMXMJOifvuCneGC2T2uB6G2g5yD54-onmKIETyNX0LtpR1MsZmKLgru5ugwIDAQAB",2:"MIIBCgKCAQEAkOpym7xC3sSysw5DAidLoVF7JUgnvXejbieDWmEiD-DQOKxzfQqYHoFfeeix__bx3wMW3I8cAc8zwZ1JO8hyB2ON732JE2Zp301GAUMnAK_rBhQWmYKP_-uXSKeTJPiuaW9PVG0oRJ4MEdS-t1vIA4eDPhI1EexHaY3P2wHKoV8twcGvdWUZB5gxEpMbx5CuvEXptnXEJlxKou3TZu9uwJIo0pgqVLUgRpW1RSRipgutpUslBnQ72Bdbsry0KKVTlcPsudAnnWUtsMJNgmyQbESPm-aVv-GzdVUFvWKpKkAxDpNArPMf0xt8VL2frw2LDe5_n9IMFogUiSYt156_mQIDAQAB",3:"MIIBCgKCAQEAyvxCWbLvtMRmq57oFg3mY4DWfkb1dir7b29E8UcwcKDcCsGTqoIhubU2pO46TVUXmFgC4E-Zlxt-9F-YA-MY7i_5GrDvySwAy4nbDhRL6Z0kz-rqUirgm9WWsP9v-X_BwzARqq83HNBuzAjf3UHgYDsKmCCarVAzRplZdT3Q5rnNiYPYSHzwfUhKEAyXk71UdtleD-bsMAmwnuYHLhDHiT279An_Ta93c9MTqa_Tq2Eirl_NXn1RdtbNohmMXldAH-C8uIh3Sz8erS4hZFSdUG1WlDsKpyRouNPQ3diorbO88wEAgpHjXkOLj63d1fYJBFG0yfu73U80aEZehQkSawIDAQAB",4:"MIIBCgKCAQEA0TVoXLpgluaqw3P011zFPSIzWhUMBqXT-Ocjy8NKjJbdrbs53eRFKk1waeB3hNn5JEKNVSNbUIe-MjacB9P34iCfKtdnrdDB8JXx0nIbIPzLtcJC4HCYASpjX_TVXrU9BgeCE3NUtnIxjHDy8PCbJyAS_Pv299Q_wpLWnkkjq70ZJ2_fX-ObbQaZHwsWKbRZ_5sD6rLfxNACTGI_jo9-vVug6AdNq96J7nUdYV1cG-INQwJJKMcAbKQcLrml8CMPc2mmf0KQ5MbS_KSbLXHUF-81AsZVHfQRSuigOStQKxgSGL5osY4NrEcODbEXtkuDrKNMsZYhijKiUHBj9vvgKwIDAQAB",5:"MIIBCgKCAQEAueOWC26w-HlOLW7s88WeWkXpjxK4mkjqngIzwbjnsU9145R51HvsILvjXJNdAuueVDHj3OOtQjfUM6eMMLr-3kaPv68y4FNusvB49uKc5ETI0HtHmHFSn9qAZvC7dQHSpYqC2TeCus-xKeUciQ5AmSfwpNtwzM6Oh2TO45zAqSA-QBSk_uv9TJu0e1W1AlNmizQtHX6je-mvqZCVHkzGFSQWQ8DBL9dHjviI2mmWfL_egAVVhBgTFXRHg5OmJbbPoHj217Yh-kHYA8IWEAHylboH6CVBdrNL4Na0fracQVTm-nOWdM95dKk3fH-KJYk_SmwB47ndWACLLi5epLl9vwIDAQAB",6:"MIIBCgKCAQEA2PJRM7-4R97rHwY_zCkFA8B3llawb6gF7oAZCpxprl6KB5z2cqLAvUfEOBtnr7RIturX04p3ThnwaFnAR7ADVZWBGOYuAyaLzGHDI5mvs8D-NewG9vw8qRkTT7Mb8fuOHC6-_lTp9AF2OA2H4QYiT1vt43KbuD0Y2CCVrOTKzDMXG8msl_JvAKt4axY9RGUtBbv0NmpkBCjLZri5AaTMgjLdu8XBXCqoLx7qZL-Bwiv4njw-ZAI4jIszJTdGzMtoQ0zL7LBj_TDUBI4Qhf2bZTZlUSL3xeDWOKmd8Frksw3oKyJ17oCQK-EGau6EaJRGyasBXl8uOEWmYYgqOWirNwIDAQAB"},e.equivalentDomains=Object.values({Amazon:["amazon.com","amazon.ca","amazon.cn","amazon.co.jp","amazon.co.uk","amazon.com.au","amazon.com.br","amazon.de","amazon.es","amazon.fr","amazon.it"],"American National Bank Fox Cities":["anbfc.bank","ufsdata.com"],Microsoft:["bing","hotmail.com","live.com","microsoft.com","msn.com","outlook.com","skype.com","xbox.com","windows.com","microsoftonline.com","windowsazure.com","azure.com"],"Bank of America":["bofa.com","bankofamerica.com"],"Harris Bank":["bmoharris.com","harrisbank.com","bmoharriscreditcard.com"],Google:["google.com","gmail.com","youtube.com"],Apple:["apple.com","icloud.com"],"Wells Fargo":["wellsfargo.com","wf.com"],Cnet:["cnet.com","cnettv.com","news.com"],Gap:["athleta.com","bananarepublic.com","gap.com"],Citi:["accountonline.com","citi.com","citibank.com","citibankonline.com","citicards.com"],Discover:["discover.com","discovercard.com"],United:["united.com","unitedairlines.com","unitedwifi.com"],Alibaba:["alibaba.com","aliexpress.com","alimama.com","taobao.com","tmall.com","1688.com"],"Alibaba Cloud":["aliexpress.com","aliyun.com","alibabacloud.com"],Salesforce:["salesforce.com","desk.com","force.com"],Yahoo:["yahoo.com","flickr.com"],PayPal:["paypal.com","paypal-search.com"],Cox:["cox.com","cox.net","coxbusiness.com"],Norton:["mynortonaccount.com","norton.com"],Verizon:["verizon.net","verizon.com"],Comcast:["comcast.com","comcast.net","xfinity.com","xfinity.net"],Gogo:["gogoair.com","gogoinflight.com"],Sony:["playstation.com","sonyentertainmentnetwork.com"],Zendesk:["zendesk.com","zopim.com"],Facebook:["facebook.com","messenger.com"],Disney:["disney.com","disneymoviesanywhere.com","disneystore.com","go.com","disneymovieinsiders.com"],Bancomer:["bancomer.com","bancomer.com.mx","bbvanet.com.mx"],Intuit:["intuit.com","mint.com","quickbooks.com","turbotax.com"],Shopify:["shopify.com","myshopify.com"],Schwab:["schwab.com","charlesschwab.com","schwabplan.com"],Tesla:["tesla.com","teslamotors.com"],"Morgan Stanley":["morganstanley.com","morganstanleyclientserv.com","ms.com","stockplanconnect.com"],Ameritrade:["ameritrade.com","tdameritrade.com","td.com","tdbank.com"],"Merrill Lynch":["mymerrill.com","ml.com"],Sirius:["siriusxm.com","sirius.com"],Basecamp:["basecamp.com","basecamphq.com","highrisehq.com"],Oracle:["mysql.com","oracle.com"],"M&T Bank":["mandtbank.com","mtb.com"],Southwest:["southwest.com","southwestwifi.com"],"Alaska Air":["alaskaair.com","alaskaairlines.com"],"JC Penny":["jcp.com","jcpenny.com"],"Mercado Libre":["https://www.mercadolibre.com/","mercadolivre.com"],"T-mobile":["tmobile.com","t-mobile.com","telekom.com","t-online.de"],HBO:["hbo.com","hbogo.com"],"Tech Data":["techdata.com","techdata.ch"],"Capital One":["capitalone.com","capitalonebank.com","capitalone360.com"],Gizmodo:["deadspin.com","gizmodo.com","jalopnik.com","jezebel.com","kotaku.com","lifehacker.com","splinternews.com","theroot.com"],"Sky Sports":["skysports.com","skybet.com","skyvegas.com"],Wikimedia:["wikimedia.org","wikipedia.org","wikinews.org","wikinews.org"],Citrix:["citrix.com","citrixonline.com"],Nordstrom:["nordstrom.com","nordstromrack.com","hautelook.com"],CNBC:["cnbc.com","nbcuni.com"],"BlueCross BlueShield":["hcsc.net","bcbsil.com"],"California Credit Union":["ccu.com","ccudigitalbanking.com"]}).map(e=>[new RegExp("^(?:"+e.map(e=>e.replace(".","\\.")).join("|")+")$","i"),e])}function initializeSettings(){var e=bg.get("settings"),t=bg.get("enforcements");const n={fillPrompt:"restrict_prompt_to_fill",autoSubmit:"restrict_auto_submit"};for(const o in e){const e=!0;let a;if(t&&t[n[o]])a=!1;else if("loginPrompt"===o){if(null===(a=localStorage.getItem(o)))a=e;else try{a=JSON.parse(a)}catch(t){a=e}localStorage.setItem(o,a)}else getIsLoggedIn()&&(a=localSetting.getItem(o),"matchOnSubdomain"===o?null===a&&(a=!1):null===a&&(a=e),localSetting.setItem(o,a));bg.set("settings."+o,a)}return getSettings()}function getSettings(){return deepClone(bg.get("settings"))}function updateSettings(e){e.hasOwnProperty("showLocks")?sendMessage("toggleMutationObserver",{showLocks:e.showLocks}):e.hasOwnProperty("onlyLoginFields")?sendMessage("toggleOnlyShowLoginFields",{onlyLoginFields:e.onlyLoginFields}):e.hasOwnProperty("hoverLocks")&&(e.hoverLocks?sendMessageToAllTabs("enabledHoverLock"):sendMessageToAllTabs("disabledHoverLock")),merge(bg.get("settings"),e)}function getIsLoggedIn(){return bg.get("isLoggedIn")}function getLanguage(){var e=navigator.language.split("-");if(e.length>1){var t=e[0]+"_"+e[1].toUpperCase();if(-1!==["en_US","ar_AE","de_DE","el_GR","en_GB","es_ES","fr_FR","it_IT","iw_IL","ja_JP","ko_KR","nl_NL","pl_PL","pt_BR","pt_PT","ro_RO","ru_RU","sk_SK","zh_CN","zh_HK","zh_TW"].indexOf(t))return t}return function(e){var t;switch(e){case"ar":t="ar_AE";break;case"de":t="de_DE";break;case"el":t="el_GR";break;case"es":t="es_ES";break;case"fr":t="fr_FR";break;case"it":t="it_IT";break;case"he":case"iw":t="iw_IL";break;case"ja":t="ja_JP";break;case"ko":t="ko_KR";break;case"nl":t="nl_NL";break;case"pl":t="pl_PL";break;case"pt":t="pt_PT";break;case"ro":t="ro_RO";break;case"ru":t="ru_RU";break;case"sk":t="sk_SK";break;case"zh":t="zh_CN";break;default:t="en_US"}return t}(e[0])}function merge(e,t){for(let n in t)"object"==typeof t[n]?merge(e[n],t[n]):e[n]=t[n]}function deepClone(e){if(void 0===e)return{};try{return JSON.parse(JSON.stringify(e))}catch(e){return logger({data:"deepClone() passed an unparsable object.",consoleFunction:console.warn}),{}}}function autoFill({payload:e,displayMode:t},n,o,a){var r=a||bg.get("lastInputField"),s=r?r.readyInput:null,i=r?r.frameUrl:null,c=r?r.pageUrl:null;r&&("http:"===getProtocol(i)?confirmFromIframe(translateThis("autofill_fill_http").replace("XXX",c),null,s,function(a){a&&sendMessage("autoFill",{displayMode:t,lastInputField:s,payload:e,fromFrame:!!o,tabId:n})}):sendMessage("autoFill",{displayMode:t,lastInputField:s,payload:e,fromFrame:!!o,tabId:n}))}function fillMasterPasswordEnforcedRecord(){var e=bg.get("masterPasswordReEntryRecord");e&&(autoFill({payload:e.record,displayMode:"record"},e.tabId,!1,e.inputField),bg.set("masterPasswordReEntryRecord",{}))}function doMPEnforcedAction(){sendMessage("MPReentry",{fromIframe:bg.get("MPReentryFromIframe"),closeWindow:bg.get("MPReentryCloseWindow")})}function getProtocol(e){return new URL(e).protocol}function confirmFromIframe(e,t,n,o){sendMessage("contextMenuConfirmation",t?{lock:t}:{input:n},null,function(t){t.canSendMessage&&sendMessage("confirmContextMenuFill",{message:e},null,function(e){var t=e.confirm;sendMessage("removeContextMenuConfirmation",null,null,function(){o(t)})})})}function urlHelperFactory(e){return!/^https?:\/\//.test(e)&&/(?:[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])/.test(e)?"":(/^https?:\/\//.test(e)||(e="https://"+e),"https://"==e?"":(e=e.replace(/\*\./g,""),function(t,n){try{var{protocol:o,host:a,pathname:r,search:s}=new URL(e)}catch(t){const n=e.match(/https?:\/\/((?:\d{1,3}\.?){4}(?::\d{2,4})?)/);if(!n)throw t;var{protocol:o,host:a,pathname:r,search:s}=new URL(e.replace(n[0],"http://foo.bar"));a=n[1]}return[o+="//",a.replace(/^www\./,""),r,s].slice(t,n).join("")}))}bg.settings=new Proxy({hoverLocks:null,showLocks:null,loginPrompt:null,fillPrompt:null,autoSubmit:null,savePrompt:null,changePrompt:null,disablePrompt:null,onlyLoginFields:null,matchOnSubdomain:null},(()=>{let e=null;const t={get(e,n){const o=e[n];return"object"==typeof o&&null!==o?new Proxy(o,t):o},set(t,n,o){if("string"==typeof o)try{o=JSON.parse(o)}catch(e){logger({data:"Faild parse key:"+n+" and value:"+o,consoleFunction:console.log}),logger({data:new Error("Error parsing setting value... \n"+e.message),consoleFunction:console.error})}return t[n]!==o&&(e&&clearTimeout(e),e=setTimeout(()=>{for(let e of Object.keys(t)){("loginPrompt"===e?localStorage:localSetting).setItem(e,t[e])}},0),t[n]=o),!0}};return t})()),appendBGFunctions(bg),initializeSettings();var domainPartsCache={};function getDomainAsArray(e){if(null==e)throw new Error("getDomainAsArray: host was null or undefined");var t,n=[];if(domainPartsCache[e])n=domainPartsCache[e];else{if(e.match(/^((?:\d{1,3}\.?){4}(?::\d{2,5})?)$/)||-1===e.indexOf("."))domainPartsCache[e]=e,n.push(e);else{var o=e.match(/:[0-9]+/);if(o&&(e=e.substring(0,o.index)),/[!@#$%^&*(),?":{}|<>]/i.test(e)){var a=[];e.split(".").forEach(e=>{/[!@#$%^&*(),?":{}|<>]/i.test(e)||a.push(e)}),e=a.join(".")}const i=psl.parse(e);if(i.listed)i.subdomain&&i.subdomain.split(".").map(e=>n.push(e)),i.domain&&(o&&(i.domain=i.domain.concat(o[0]),e=e.concat(o[0])),n.push(i.domain)),0===n.length&&n.push(e);else{var r=i.input.split("."),s="";r.length>0&&["local"].some((t=r[r.length-1],function(e){return!!e.includes(t)&&(s=t,!0)}))&&s&&(r[r.length-2]=r[r.length-2]+"."+r[r.length-1].slice(0,s.length)+(o?o[0]:""),delete r[r.length-1]),r.forEach(e=>{n.push(e)})}}domainPartsCache[e]=n}return n}function hostFromURL(e){if(!e)return"";try{var t=new URL(e);return"file://"!==t.origin?t.hostname:t.href}catch(t){if(0!==e.indexOf("http"))return hostFromURL("https://"+e.trim())}}function domainFromURL(e){var t=hostFromURL(e);if(t){var n=t.split("."),o=n[n.length-1],a=n[n.length-2];return"com"===o||"net"===o||"org"===o?n.slice(-2).join("."):a&&2===o.length&&"com"===a?n.slice(-3).join("."):n.length<=2?t:n.slice(1).join(".")}return t}function doSendAPIRequest(e,t,n){e?keeperAPICall(e).then(function(o){n?n(o,t):function(t,o){var a=bg.get("auth_queue");if(bg.get("sessionToken")&&"auth_failed"===t.result_code){if(bg.set("authSalt",t.salt),bg.get("auth_queue").length>0)return a.push([e,o,n]),void bg.set("auth_queue",a);if(logger({data:"session token has expired!",consoleFunction:console.log}),a.push([e,o,n]),bg.set("auth_queue",a),1===bg.get("auth_queue").length)return logger({data:"attempting auto re-authenticate",consoleFunction:console.log}),void reAuthenticate(function(e){logger({data:"  re-authenticate "+(e?"success":"fail"),consoleFunction:console.log});var t=bg.get("auth_queue");bg.set("auth_queue",[]);for(var n=0;n<t.length;n++)doSendAPIRequest.apply(this,t[n])})}"throttled"!==t.result_code&&"bad_password"!==t.result_code&&"auth_failed"!==t.result_code&&"incorrect_authentication_method"!==t.result_code||Logout();o&&o(t)}(o,t)}).catch(function(e){logger({data:e,consoleFunction:console.error}),void 0!==t&&t(e)}):t&&t()}function sendRequest(e,t,n,o,a){var r=new XMLHttpRequest;r.open("GET",e+"?rnd="+Math.random()),r.responseType="text",r.overrideMimeType(o||"text/plain"),r.onload=function(){t(this.response)},r.onerror=function(){t(null)},r.send()}function getTheme(){return localSetting.removeItem("theme"),"metal"===bg.get("account_settings.theme")&&bg.set("account_settings.theme","classic"),bg.get("account_settings.theme")}function setTheme(e){bg.get("isLoggedIn")&&getTheme()!==e&&setAccountSetting("theme",e,function(t){"success"===t.result&&bg.set("account_settings.theme",e)})}function getAccountSettings(e){doSendAPIRequest({command:"account_summary",include:["settings","enforcements"]},function(t){e(t.settings,t.enforcements)})}function setAccountSetting(e,t,n){var o={command:"single_setting"};o.new_setting=e,o.new_string=t,doSendAPIRequest(o,function(o){o&&"success"===o.result&&sendMessage("settingChanged",{setting:e,value:t}),n(o)})}function getStringMatchedRecords(e,t){var n=new RegExp(e.replace(/(\$|\^|\*|\(|\)|\+|\?|\[|\]|\\|\|)/g,"\\$1"),"i"),o=getRecordsAsArray().filter(function(e){if(n.test(e.folder)||n.test(e.title)||n.test(e.secret1)||n.test(e.secret2)||n.test(e.link)||n.test(e.notes))return!0;if(e.custom&&e.custom.length>0)for(var t=0;t<e.custom.length;t++){var o=e.custom[t];if("text"===o.type&&(n.test(o.name)||n.test(o.value)))return!0}if(e.extra&&e.extra.files)for(t=0;t<e.extra.files.length;t++){var a=e.extra.files[t];if(n.test(a.title))return!0}if(e.extra&&e.extra.fields)for(t=0;t<e.extra.fields.length;t++){var r=e.extra.fields[t];if(n.test(r.field_type))return!0}return!1});o.sort(recordTitleSort),t(o)}function getMatchedCustomFieldRecord(e,t,n,o){var a;if(n&&0!=n.length?customFieldUrls=getAllMatchedCustomFieldURLs(e.custom,n):customFieldUrls=getAllMatchedCustomFieldURLs(e.custom,t),customFieldUrls.forEach(function(n){var r=o.some(function(t){return e.record_uid==t.record_uid});try{n.indexOf(t)>-1&&n!=urlHelperFactory(e.link)(1,2)&&(a=e)}catch(o){!r&&n.indexOf(t)>-1&&(a=e)}}),a)return a}function getCurrentBaseDomain(e){return localSetting.getItem("matchOnSubdomain")?e.join("."):e[e.length-1]}function getUrlMatchedRecords(e,t,n){const o=urlHelperFactory(e),a=getDomainAsArray(o(1,2)),r=a[a.length-1].slice(0,a[a.length-1].indexOf(".")),s=getCurrentBaseDomain(a),i=o(2);let c=[];bg.get("equivalentDomains").some(([e,t])=>{if(e.test(s))return c=t,!0});const l=a.length-1,d=translation[getLanguage()].Login_Link,u=[],g=[];let m=[];getRecordsAsArray().forEach(function(e){const{title:t="",link:n="",custom:a=[]}=e,i=a.filter(e=>e.name===d&&e.value).map(e=>e.value),l=(n?[n]:[]).concat(i);if(e.custom&&0!=e.custom.length){var p=getMatchedCustomFieldRecord(e,s,c,u);p&&u.push(p)}for(let t of l){try{var f=urlHelperFactory(t);f()}catch(e){logger({data:t+e,consoleFunction:console.error});continue}const n=getDomainAsArray(f(1,2));if(n.length>0){const t=n[n.length-1];t.slice(0,t.indexOf("."));if(f(1,2)===o(1,2)||c.indexOf(t)>-1)return u.push(e);if(t===s){return(m[n.length-1]=m[n.length-1]||[]).push({recordDomain:n,record:e})}}}if(0===l.length&&t&&r.length>=6&&new RegExp("^"+r+"$","i").test(t))return g.push(e)}),u.sort(sortRecordsByDate);let p=[];m=(m=m.reduceRight((e,t,n)=>n>l?(p=p.concat(t),e):e.concat(t.slice().sort(b).sort(y).map(({record:e})=>e)),[])).concat(p.sort(b).sort(y).map(({record:e})=>e));let f=u.concat(m,g),h=function(e,t){if(!t)return e;var n=[],o=[].concat(e),a=0;return e.forEach((e,r)=>{t.includes(e.secret1)&&(n.push(e),o.splice(r-a,1),a++)}),n.sort(sortRecordsByDate),n.concat(o)}(function(e,t,n,o){var a=[],r=[].concat(n),i=0;if(n.forEach((n,o)=>{var l;n&&n.custom&&(l=getMatchedCustomFieldRecord(n,s,c,u)),n&&n.link&&n.link.indexOf(e)>-1&&(1==t.length&&1==getDomainAsArray(urlHelperFactory(n.link)(1,2)).length?(a.push(n),r.splice(o-i,1),i++):n&&n.custom&&l?(a.push(n),r.splice(o-i,1),i++):t.length>1&&(a.push(n),r.splice(o-i,1),i++))}),a.sort(sortRecordsByDate),localSetting.getItem("matchOnSubdomain")){var l=v(o,a);return l.length>0?l:l.concat(r)}return v(o,a).concat(r)}(o(1,2),a,f,i),n);return _.uniqBy(h,"record_uid");function b(e,t){c_subdomains=a.slice(0,-1).reverse(),a_subdomains=e.recordDomain.slice(0,-1).reverse(),b_subdomains=t.recordDomain.slice(0,-1).reverse();for(let e=0;e<a_subdomains.length;e++){const t=c_subdomains[e]===a_subdomains[e],n=c_subdomains[e]===b_subdomains[e];switch(!0){case t&&!n:return-1;case!t&&n:return 1;case!t&&!n:return a_subdomains[e].localeCompare(b_subdomains[e])}}return 0}function y(e,t){return e.record.link===t.record.link&&e.record.non_shared_data&&t.record.non_shared_data?t.record.non_shared_data.last_filled_time-e.record.non_shared_data.last_filled_time:0}function v(e,t){var n=[],o=[].concat(t),a=0,r={};t.forEach((e,t)=>{var s;try{s=e&&e.link&&urlHelperFactory(e.link)(2)}catch(t){"string"!=typeof(s=e&&e.link&&urlHelperFactory(e.link))&&(s="")}s&&(r={record:e,path:s},n.push(r),o.splice(t-a,1),a++)});var s=[],i=0;n.forEach(t=>{for(var n=0;n<e.length;n++){if(e.charAt(n)!==t.path.charAt(n)){s.push([t.record,i]),i=0;break}if(++i===e.length){t.path.length>e.length&&t.path.length-e.length>2?(i=0,s.push([t.record,i])):(s.push([t.record,i]),i=0);break}}});var c=[];return s.sort((e,t)=>t[1]-e[1]).forEach(e=>{c.push(e[0])}),c.concat(o)}}function getAllMatchedCustomFieldURLs(e,t){var n=[];return e.forEach(function(e){var o,a="";if(Array.isArray(t)){if(o=[],""!=e.value)try{a=urlHelperFactory(e.value)(1,2)}catch(e){a=""}t.forEach(function(e){try{var t=urlHelperFactory(e)(1,2);o.push(t)}catch(e){o=""}})}else{o="";try{o=urlHelperFactory(t)(1,2)}catch(e){o=""}if(""!=e.value)try{a=urlHelperFactory(e.value)(1,2)}catch(e){a=""}}Array.isArray(o)?o&&a&&(o.some(e=>e==a)||o.some(e=>a.indexOf(e))>-1)&&n.push(a):o&&a&&(o==a||a&&a.indexOf(o)>-1)&&n.push(a)}),n}function getRecentRecords(e,t){var n=getRecordsAsArray().sort(sortRecordsByDate);e=e||10,t(n.slice(0,e))}function sortRecordsByDate(e,t){var n=e.non_shared_data&&e.non_shared_data.last_filled_time?e.non_shared_data.last_filled_time:0,o=n>e.client_modified_time?n:e.client_modified_time,a=t.non_shared_data&&t.non_shared_data.last_filled_time?t.non_shared_data.last_filled_time:0,r=a>t.client_modified_time?a:t.client_modified_time;return o<r?1:o>r?-1:0}function getFavoriteRecords(e,t){var n=getRecordsAsArray().filter(function(e){return e.non_shared_data&&e.non_shared_data.favorite});(e=e||10)<n.length&&(n.length=e),t(n)}function goodTokenAndKey(e){return!(!bg.get("sessionToken")||!bg.get("encryptionKey"))||(e({result:"fail",message:translation[getLanguage()].Network_error}),!1)}function uploadPersonalInfo(e,t,n){goodTokenAndKey(n)&&doSendAPIRequest({command:"update_profile",pt:clientID,device_id:bg.get("deviceId"),device_name:bg.get("deviceId"),client_id:bg.get("clientId"),username:bg.get("uname"),data:KeeperAPI.encrypt(t,bg.get("encryptionKey")),profile_name:e},function(e){n&&n(e);try{makeContextMenu()}catch(e){logger({data:"There was an error making the context menu",consoleFunction:console.error})}})}function auditAllRecords(){const e=checkPassword(bg.get("pass")).score.percentage/100;let t=0,n=0,o=0,a=0;const r=[];return getOwnedRecordsAsArray().forEach(e=>{if(e.secret2){const{score:s}=checkPassword(e.secret2);n+=1,-1===r.indexOf(e.secret2)&&(t+=1,r.push(e.secret2)),/weak/i.test(s.rating)&&(o+=1),/strong/i.test(s.rating)&&(a+=1)}}),{master_password_strength:e,unique_record_passwords:t,total_record_passwords:n,weak_record_passwords:o,strong_record_passwords:a}}function sendRecordAuditReport(e){doSendAPIRequest(Object.assign(auditAllRecords(),{command:"set_user_report_parameters",pt:clientID,device_id:bg.get("deviceId"),device_name:bg.get("deviceId"),client_id:bg.get("clientId"),username:bg.get("uname")}),function(t){"success"===t.result&&e&&e(t)})}function auditRecord(e,t,n,o){if(!bg.get("account_settings")||bg.get("account_settings.audit")){var a=[];if(t){getRecordsAsArray().some(e=>e.secret2===t)&&a.push({audit_event_type:"reused_password",inputs:{record_uid:e}})}auditEventLogging(e,n,a,o)}}function auditEventLogging(e,t,n,o){if(bg.get("account_settings")&&!bg.get("account_settings.audit"))return;const a={command:"audit_event_client_logging",username:bg.get("uname"),device_id:bg.get("deviceId"),session_token:bg.get("sessionToken"),item_logs:[]};t&&a.item_logs.push({audit_event_type:t,inputs:{record_uid:e}}),n&&n.length>0&&(a.item_logs=a.item_logs.concat(n)),a.item_logs.length>0&&doSendAPIRequest(a,function(e){"success"===e.result&&o&&o(e)})}function uploadRecord(e,t,n=!0){if(!goodTokenAndKey(t))return;const o=KeeperAPI.encryptedRecordAsUploadRequest(e);doSendAPIRequest(o,function(a){var r=a.results?a.results[0]:null;if(r){var s=r.update_records&&r.update_records[0]&&r.update_records[0].status;if("success"===r.result)if("record_add"==r.command){var i=e;i.revision=r.revision,i.record_uid=o.requests[0].record_uid,addRecordToCache(i),r.record=i,r.add_records=[{record_uid:i.record_uid,status:r.result}],t(r,i)}else"record_update"==r.command&&"success"===s?(r=a.results[0].update_records?a.results[0].update_records[0]:a.results[0],e.revision=a.results[0].revision,addRecordToCache(e),t(a.results[0],e),sendRecordAuditReport(function(e){})):"out_of_sync"===s&&!0===n&&syncDown(function(n,o){if(o.length&&(debugmode&&sendMessage("backgroundError",{data:o}),logger({data:o,consoleFunction:console.error})),"success"===n.result){const n=getRecordById(e.record_uid).revision;e.revision=n,uploadRecord(e,function(e,n){t(e,n)},!1)}})}})}function updateNonSharedData(e,t,n){if(e&&e.record_uid){var o,a=e.non_shared_data||{};for(let e in t)a[e]=t[e];2===e.record_key_type&&(o=KeeperAPI.encrypt(e.record_key,bg.get("encryptionKey")),e.record_key_type=1),bg.setCacheProp(`non_shared_data.${e.record_uid}`,a);var r,s=getRecordsAsArray();if(!1===n){for(var i=0;i<s.length;i++)if(s[i].record_uid===e.record_uid){s[i].non_shared_data=a,s[i].record_key_type=e.record_key_type;break}bg.setCacheProp("records_array",s)}try{r=KeeperAPI.encrypt(JSON.stringify(a),bg.get("encryptionKey"))}catch(e){return void logger({data:"Record last filled, crypto error.",consoleFunction:console.error})}var c={command:"record_update",client_time:Date.now(),pt:clientID,device_id:bg.get("deviceId"),update_records:[{record_uid:e.record_uid,shared_folder_uid:e.shared_folder_uid,team_uid:e.team_uid,version:"2",client_modified_time:e.client_modified_time,non_shared_data:r,record_key:o,revision:e.revision}]};if(!1===n)return c;doSendAPIRequest(c,function(t){if("function"==typeof n)if("success"===t.result){for(var o,r=0;r<s.length;r++)if(s[r].record_uid===e.record_uid){s[r].non_shared_data=a,s[r].record_key_type=e.record_key_type,o=s[r];break}bg.setCacheProp("records_array",s),n(o||t.update_records[0]);try{makeContextMenu()}catch(e){logger({data:"There was an error making the context menu",consoleFunction:console.error})}}else n(t)})}}function sendCredentials(){var e=bg.get("temp_login"),t=bg.get("temp_password");return e&&t?(bg.set("temp_login",""),bg.set("temp_password",""),{vault_login:e,vault_password:t}):{vault_login:bg.get("uname"),vault_password:bg.get("pass"),vault_is_sso:bg.get("isSsoUser"),remember_email:localStorage&&localStorage.getItem?localStorage.getItem("rememberedEmail"):"",vault_device_tokens:bg.get("deviceToken"),tokenExpiry:bg.get("device_token_expire_days"),remember_device_token:bg.get("remember_device_token"),sso_domain:localStorage.getItem("ssoServiceProvider")}}function lastFillTimeOnInputField(e,t){var n=bg.get("lastFilledFieldsByRecord"),o=n[e.record.record_uid];if(t){if(e.field["data-keeper-lock-id"]&&delete e.field["data-keeper-lock-id"],o){var a,r=!1;o.forEach((t,n)=>{if(JSON.stringify(e.field)===JSON.stringify(t.field))return r=!0,void(a=n)}),r?a&&(o=o.splice(a,1)).push({field:e.field,time:Date.now()}):o.push({field:e.field,time:Date.now()})}else o=[{field:e.field,time:Date.now()}];n[e.record.record_uid]=o,bg.set("lastFilledFieldsByRecord",n)}return n[e.record.record_uid]||[]}function updateRecordLastFilled(e,t){if(e){var n=JSON.parse(JSON.stringify(e)),o=[updateNonSharedData(n,{last_filled_time:Date.now()},!1)];auditEventLogging(n.record_uid,"fast_fill",null,function(e){}),doSendAPIRequest({command:"execute",requests:o},function(e){if("function"==typeof t)if("success"===e.result){try{makeContextMenu()}catch(e){logger({data:"There was an error making the context menu",consoleFunction:console.error})}t(e.results[0])}else t(e)})}}function getRecordHistory(e,t){doSendAPIRequest({command:"get_record_history",record_uid:e,client_time:Date.now()},function(e){"success"===e.result?t(e.history):t(e)})}function getFolders(){if(bg.get("isLoggedIn")){var e=getRecordsAsArray().map(function(e){return e.folder||!1}).filter(function(e,t,n){return e&&n.indexOf(e)===t}).map(function(e){return{name:e}}),t=getSharedFoldersAsArray().filter(function(e){return e.manage_records}).map(function(e){return{name:e.name,shared_folder_uid:e.shared_folder_uid}});return e.concat(t).sort(function(e,t){return e.name.localeCompare(t.name)})}return[]}function Logout(e,t,n){removeContextMenu(),bg.set("temp_login",""),bg.set("temp_password",""),bg.set("isLoggedIn",!1),bg.set("isSsoUser",!1);var o=bg.get("uname");clearUserCache(o),closeWebSocket(o),clearTimeout(bg.get("inactivity_timeout")),bg.set("inactivity_settime",0),bg.set("autoFillRecord",void 0),bg.set("autoFilledOnce",!1),n||bg.set("deviceToken",void 0),bg.set("is_enterprise_admin",!1),bg.set("MPReentryTime",void 0),o=null,bg.set("uname",null),bg.get("uname"),bg.set("pass",null),bg.get("pass"),bg.set("sessionToken",null),bg.set("encryptionKey",null),bg.set("account_settings",null),bg.set("enforcements",null),bg.set("license",null),"undefined"!=typeof chrome&&chrome.browserAction&&chrome.browserAction.setIcon({path:{19:"19-inactive.png",38:"38-inactive.png"}},function(){t||logoutVault(()=>{})}),e||sendMessageToAllTabs("loggedOut",{})}function logoutVault(e){VaultMessaging.logoutVault(e)}function resetInactivityTimeout(){if(clearTimeout(bg.get("inactivity_timeout")),bg.get("isLoggedIn")){var e=getInactivityTimeout(),t=bg.get("inactivity_settime"),n=Date.now();if(e>0){var o=1e3*e;t>0&&n>t+o?Logout():(bg.set("inactivity_settime",n),bg.set("inactivity_timeout",setTimeout(Logout,o)))}}}function resetMPReentryTimeout(){var e,t=Date.now(),n=bg.get("enforcements"),o=bg.get("MPReentryTestValue"),a=n&&n.master_password_reentry&&n.master_password_reentry.timeout;e=a&&6e4*a||0==a?6e4*n.master_password_reentry.timeout:o;var r=bg.get("MPReentryTime");!Number.isNaN(e)&&void 0!=e&&!Number.isNaN(r)&&void 0!=r&&r<t-e?bg.MPReentryEnabled=!0:Number.isNaN(e)||void 0==e||0!=e?bg.set("MPReentryTime",t):bg.MPReentryEnabled=!0}function getInactivityTimeout(){var e=bg.get("enforcements")&&bg.get("enforcements.logout_timer_web")||0;if(e*=60,void 0!==localStorage.inactivityTimeout)try{var t=JSON.parse(localStorage.inactivityTimeout);if("number"==typeof t)return localStorage.removeItem("inactivityTimeout"),localSetting.setItem("inactivityTimeout",t),e>0&&t>e?e:t;var n=localSetting.getItem("inactivityTimeout");if(void 0!==n)return e>0&&n>e?e:n}catch(e){localStorage.removeItem("inactivityTimeout")}return e||0}function setInactivityTimeout(e,t){e=parseInt(e),Number.isNaN(e)||void 0==e?e=1800:(e>1728e3||e<0)&&(e=0),0===e?localSetting.removeItem("inactivityTimeout"):localSetting.setItem("inactivityTimeout",e),t&&sendMessageToAllTabs("setTimeout",{timeout:e}),bg.set("inactivity_settime",Date.now()),resetInactivityTimeout()}function getProtobufMessageBytes(e,t,n){const o=publicKeyEncrypt(t,bg.get("URLSafeBase64PublicStrings")[e]),a=transmissionKeyEncrypt(n,t),r={encryptedTransmissionKey:o,publicKeyId:e,locale:getLanguage(),encryptedPayload:a},s=ApiRequest.verify(r);if(null!=s)throw logger({data:s,consoleFunction:console.error}),new Error(s);const i=ApiRequest.create(r);return ApiRequest.encode(i).finish()}function transmissionKeyEncrypt(e,t){return base64urlsafe_to_bytes(KeeperAES256GCMencrypt(e,t))}function publicKeyEncrypt(e,t){const n=base64urlsafe_to_hex(t),o=ASN1HEX.getPosArrayOfChildren_AtObj(n,0),a=ASN1HEX.getHexOfV_AtObj(n,o[0]),r=ASN1HEX.getHexOfV_AtObj(n,o[1]),s=new RSAKey;return s.setPublic(a,r),asmCrypto.hex_to_bytes(s.encryptBinary(asmCrypto.bytes_to_hex(e)))}function convertToBytes(e){const t=[];for(let n=0,o=e.length;n<o;n++)t.push(e.charCodeAt(n));return new Uint8Array(t)}function doProtoRequestCompile(e,t){if(t){if(null!=e.verify(t))throw new Error("Failed to verify protobuf request payload.");var n=e.create(t);return e.encode(n).finish()}}function compileRequest(e){var t={url:null,payload:null,apiPayload:null,apiRequestPayload:null,protoRequest:null,protoResponse:null,apiPayload:null};switch(e.command){case API_COMMANDS.GET_DEVICE_TOKEN:var n={clientVersion:client_version,deviceName:""};t.url=DEVICE_TOKEN_URL,t.payload=n,t.protoRequest=DeviceRequest,t.protoResponse=DeviceResponse;break;case API_COMMANDS.PRE_LOGIN:var o={authRequest:{clientVersion:client_version,username:e.uname,encryptedDeviceToken:bg.get("encryptedDeviceToken")},loginType:bg.get("logintype")};t.url=PRE_LOGIN_URL,t.payload=o,t.protoRequest=PreLoginRequest,t.protoResponse=PreLoginResponse;break;case API_COMMANDS.MASTER_PASSWORD_REENTRY_ACTION_TYPE:var a={pbkdf2Password:e.pbkdf2Password};t.url=MASTER_PASSWORD_REENTRY_ACTION_TYPE_URL,t.payload=a,t.protoRequest=MasterPasswordReentryRequest,t.protoResponse=MasterPasswordReentryActionType;break;default:e.username||(e.username=bg.get("uname")||void 0),e.session_token=bg.get("sessionToken")||void 0,e.locale=getLanguage(),e.client_version=client_version,logger({group:"Browser Extension to KeeperApp",name:e.command,data:e,whichMessages:{apiMessages:!0},consoleFunction:console.log});var r={payload:utf8_to_bytes(JSON.stringify(e)),encryptedSessionToken:bg.get("sessionToken")?base64urlsafe_to_bytes(bg.get("sessionToken")):void 0,timeToken:void 0,apiVersion:0};return t.url=API_URL,t.apiRequestPayload=r,t.protoRequest=ApiRequestPayload,t.protoResponse=JsonProto,t}return logger({group:"Browser Extension to KeeperApp",name:e.command,data:t.payload,whichMessages:{apiMessages:!0},consoleFunction:console.log}),t.apiPayload=t.payload instanceof Uint8Array?t.payload:(()=>doProtoRequestCompile(t.protoRequest,t.payload))(),t}function setIsOffline(e){bg.set("isOffline",e)}function isOffline(e){return bg.get("isOffline")}function keeperAPICall(e){return appendBGFunctions(bg),new Promise(function(t,n){delete e.password;var o=e.serializedData,a=compileRequest(e),r=e.transmissionKeyId?e.transmissionKeyId:bg.get("PUBLIC_KEY_ID"),s=random(256);if(!o){var i=null!=a.apiRequestPayload?a.apiRequestPayload:{payload:a.apiPayload,encryptedSessionToken:bg.get("sessionToken")?base64urlsafe_to_bytes(bg.get("sessionToken")):void 0,timeToken:void 0,apiVersion:0};o=doProtoRequestCompile(ApiRequestPayload,i)}var c=getProtobufMessageBytes(r,s,o);delete e.transmissionKeyId,delete e.serializedData;var l=new XMLHttpRequest;l.open("POST",a.url),l.responseType="arraybuffer",l.onload=function(){setIsOffline(!1);const i="string"==typeof this.response?convertToBytes(this.response):new Uint8Array(this.response);if(this.status>=200&&this.status<300){var c=void 0;if(0==i.length&&"validate_master_password"==e.command)logger({group:"KeeperApp to Browser Extension",name:"validate_master_password",data:"good",whichMessages:{apiMessages:!0},consoleFunction:console.log}),t({result:"success"});else try{const n=KeeperAES256GCMdecryptToBytes(i,s);c=a.protoResponse.decode(n),logger({group:"KeeperApp to Browser Extension",name:e.command,data:c,whichMessages:{apiMessages:!0},consoleFunction:console.log}),t(c)}catch(e){logger({data:e,consoleFunction:console.error})}}else[400,401,403,500].indexOf(this.status)>-1?pingKeeperApp(function(s){try{var c;s&&n(new Error("KeeperFill is Offline"));try{c=a.protoResponse.decode(i)}catch(e){c=bytes_to_utf8(i),c=JSON.parse(c)}logger({group:"KeeperApp to Browser Extension",name:e.command,data:c,whichMessages:{apiMessages:!0},consoleFunction:console.warn});const{key_id:l}=c;return null!=l&&l!==r?(r=l,bg.set("PUBLIC_KEY_ID",r),Promise.resolve().then(()=>keeperAPICall(Object.assign(e,{serializedData:o,transmissionKeyId:r,url:a.url}))).then(t).then(n)):t(c)}catch(t){logger({group:"KeeperApp to Browser Extension",name:e.command,data:t,whichMessages:{apiMessages:!0},consoleFunction:console.warn}),n(t)}}):(logger({group:"KeeperApp to Browser Extension",name:e.command,data:{result:"fail",result_code:"server_error",message:translation[getLanguage()].unexpected_error},whichMessages:{apiMessages:!0},consoleFunction:console.warn}),n({result:"fail",result_code:"server_error",message:translation[getLanguage()].unexpected_error}))},l.onerror=function(){setIsOffline(!0),logger({group:"KeeperApp to Browser Extension",name:e.command,data:{result:"fail",result_code:"network_error",message:translation[getLanguage()].Network_error},whichMessages:{apiMessages:!0},consoleFunction:console.warn}),n({result:"fail",result_code:"network_error",message:translation[getLanguage()].Network_error})},l.send(c)})}function reAuthenticate(e){let t=bg.get("pass","authSalt","authIterations");KeeperAPI.PBKDF2_SHA256(t.pass,t.authSalt,t.authIterations).then(function(t){keeperAPICall({command:"login",version:"2",auth_response:doubleHashAuth(t),"2fa_token":getDeviceToken(),"2fa_type":"device_token","2fa_no_send":!0}).then(function(t){bg.set("sessionToken",t.session_token),e("success"===t.result)}).catch(function(t){e(!1)})})}function APIMPReentry(e){return new Promise((t,n)=>{KeeperAPI.PBKDF2_SHA256(e.pbkdf2Password,bg.get("authSalt"),bg.get("authIterations")).then(function(n){e.pbkdf2Password=doubleHashAuth(n),doSendAPIRequest(e,function(e){"success"==e.result&&bg.set("MPReentryTime",Date.now()),t(e)})})})}function emergencyCheck(e,t){var n,o=getLanguage().split(/_/),a={pid:242,v:client_version.substr(2),uid:"webapp",email:e,language:o[0],country:o[1],format:"json"},r=[];for(n in a)r.push(encodeURIComponent(n)+"="+encodeURIComponent(a[n]));urlEncodedData=r.join("&").replace(/%20/g,"+");var s=new XMLHttpRequest;s.open("POST","https://"+KEEPERSECURITY_HOST+"/emergency_check"),s.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),s.responseType="json",s.onload=function(){t&&t(this.response)},s.onerror=function(){t&&t({})},s.send(urlEncodedData)}function loginExtension({login:e,password:t,totp:n,logintype:o,offlineErrorCallback:a,callback:r,rememberEmail:s}){function i(){try{return String(r),!0}catch(e){return!1}}Login({username:e,password:t,logintype:o,offlineErrorCallback:a,login_callback:function(n){if("success"===n.result)bg.set("temp_login",""),bg.set("temp_password",""),syncDown(function(e,t){t.length&&(debugmode&&sendMessage("backgroundError",{data:t}),logger({data:t,consoleFunction:console.error})),"success"===e.result?(initializeSettings(),"undefined"!=typeof chrome&&chrome.browserAction&&chrome.browserAction.setIcon({path:{19:"19-active.png",38:"38-active.png"}}),VaultMessaging.loginFirstVaultTabThatIsNotLoggedIn()):Logout(),i()&&r(e),sendMessage("showLoggedInKeeper")});else if("invalid_device_token"===n.result_code&&(bg.set("deviceToken",null),saveDeviceToken(bg.get("deviceToken"),e)),n.u2f_challenge&&(bg.set("temp_login",e),bg.set("temp_password",t)),bg.set("logintype",null),i())return void r(n)},rememberEmail:s,totp:n})}function doubleHashAuth(e){var t=CryptoJS.enc.URLBase64.parse(e),n=CryptoJS.SHA256(t);return CryptoJS.enc.URLBase64.stringify(n)}function doLoginAPIRequest({username:e,password:t,logintype:n,offlineErrorCallback:o,login_callback:a,rememberEmail:r,totp:s,suppressPopupRemoval:i,dtoken:c,noLoginVault:l,checkForAuthFailed:d,saltArrayInfo:u}){KeeperAPI.PBKDF2_SHA256(t,bg.get("authSalt"),bg.get("authIterations")).then(function(n){let o=bg.get("deviceToken");var r,i=s||o;s?r=s.signatureData?"u2f":/^\d{9}$/.test(i)?"backup":"one_time":o&&(r="device_token"),doSendAPIRequest({command:"login",version:"2",username:e,auth_response:doubleHashAuth(n),include:["settings","enforcements","keys","client_key","license","is_enterprise_admin"],"2fa_token":i,"2fa_type":r,device_token_expire_days:i?bg.get("device_token_expire_days"):void 0,platform_device_token:bytes_to_base64urlsafe(bg.get("encryptedDeviceToken"))||""},function(n){"Failed_to_find_user"===n.result_code?(n.message=translation[getLanguage()].InvalidEmailOrPassword,a(n)):"network_error"===n.result_code||"server_error"===n.result_code?a(n):function(n){bg.set("uname",e),bg.set("pass",t),"invalid_totp"===n.result_code||"invalid_device_token"===n.result_code||"invalid_backup_code"===n.result_code||"invalid_code_length"===n.result_code||"ACCESS_DENIED"===n.result_code?(bg.set("deviceToken",void 0),saveDeviceToken(bg.get("deviceToken"),e)):n.device_token&&(bg.set("deviceToken",n.device_token),"session"===n.dt_scope?saveDeviceToken(null,e):saveDeviceToken(n.device_token,e));if("fail"===n.result)return n.message||(n.message=translation[getLanguage()].InvalidEmailOrPassword),void(a&&a(n));bg.get("isPendingU2F")&&bg.get("u2fTabId")&&chrome.tabs.query({url:DATA_VAULT_URL},function(e){e.some(function(e){var t=bg.get("u2fTabId");return e.id==t&&(chrome.tabs.update(bg.get("u2fReturnTabId"),{selected:!0}),chrome.tabs.remove(t),!0)})});if(bg.set("isPendingU2F",!1),n.license){if(n.license.seconds_until_expiration<0)return n.result="fail",1===n.license.product_type_id?(n.result_code="free_trial_expired",n.message=translation[getLanguage()].free_trial_expired_please_purchase):(n.result_code="account_expired",n.message=translation[getLanguage()].expired_please_purchase),void(a&&a(n));bg.set("license",n.license)}n.keys&&(bg.set("encryption_params",n.keys.encryption_params),bg.set("encrypted_data_key",n.keys.encrypted_data_key),bg.set("encrypted_private_key",n.keys.encrypted_private_key));n.enforcements&&(bg.get("authIterations")<n.enforcements.minimum_pbkdf2_iterations&&changeMasterPassword(t,n.enforcements.minimum_pbkdf2_iterations),n.enforcements.master_password_reentry&&bg.set("MPReentryTime",Date.now()),bg.set("enforcements",n.enforcements));if(n.settings){if(!bg.get("sso_security_provider_url")&&n.settings.password_rules){var o=[];if(n.settings.password_rules.forEach(function(e){var n=new RegExp(e.pattern);n.test(t)!==e.match&&o.push(e.description)}),o.length>0)return n.result="fail",n.result_code="password_rule_enforcement",n.message=n.settings.password_rules_intro+"\n* "+o.join("\n* "),void(a&&a(n))}if(n.settings.twoFactorRequired)return n.result="fail",n.result_code="two_factor_enforcement",n.message=translation[getLanguage()].two_factor_required,void(a&&a(n));getDeviceToken(e)&&(n.settings.channel&&"two_factor_disabled"!==n.settings.channel||(bg.set("deviceToken",void 0),saveDeviceToken(bg.get("deviceToken"),e))),bg.set("account_settings",n.settings)}"is_enterprise_admin"in n&&bg.set("is_enterprise_admin",n.is_enterprise_admin);n.session_token&&bg.set("sessionToken",n.session_token);var r=bg.get("encryption_params"),s=bg.get("encrypted_data_key");if(s){var i=bg.get("authIterations"),c=bg.get("authSalt"),d=base64urlsafe_to_bytes(s);decryptDataClientKey(t,c,i,d).then(e=>{g(CryptoJS.enc.URLBase64.parse(bytes_to_base64urlsafe(e)))}).catch(u)}else if(r){function u(e){logger({data:e,consoleFunction:console.error}),n.result="fail",n.result_code="data_key_decryption_error",n.message=translation[getLanguage()].encryption_error,a&&a(n)}KeeperAPI.decryptEncryptionKey(t,r).then(function(e){g(e)}).catch(u)}function g(t){var o=bg.get("encrypted_private_key");if(o)try{var r,s=new RSAKey;r=t instanceof Uint8Array?KeeperAES256CBCdecryptToHex(o,t):KeeperAPI.decryptToBytes(o,t).toString(),s.readPrivateKeyFromASN1HexString(r),bg.set("rsaPrivateKey",s)}catch(e){logger({data:"Private Key decryption error: "+e.message,consoleFunction:console.error})}bg.set("encryptionKey",t),bg.set("isLoggedIn",!0),sendMessage("loggedIn",{data:{login:bg.get("uname")}}),l||sendMessageToAllTabs("vaultForceReload",{}),openWebSocket(e,function(e){!0===e.sync&&syncDown(function(e,t){try{makeContextMenu()}catch(e){logger({data:"There was an error making the context menu",consoleFunction:console.error})}t.length&&(debugmode&&sendMessage("backgroundError",{data:t}),logger({data:t,consoleFunction:console.error}))})}),a&&a(n)}}(n)},function(e,t){"auth_failed"==e.result_code&&u.currentIndex<u.length?d():t&&t(e)})})}function Login({username:e,password:t,logintype:n,offlineErrorCallback:o,login_callback:a,rememberEmail:r,totp:s,suppressPopupRemoval:i,dtoken:c,noLoginVault:l}){Logout(!0,!0),r&&localStorage.setItem("rememberedEmail",e),n=null!=n?n:bg.get("logintype"),bg.set("deviceToken",c||getDeviceToken(e)),bg.set("auth_queue",[]),bg.set("username",e),logger({data:"logging in w/ deviceToken="+bg.get("deviceToken")+" totp="+s,consoleFunction:console.log});var d=bg.get("encryptedDeviceToken")||localStorage.getItem("encryptedDeviceToken");if(d){if("string"==typeof d){var u=d.split(",").map(e=>parseInt(e));d=new Uint8Array(u)}bg.set("encryptedDeviceToken",d),localStorage.setItem("encryptedDeviceToken",d),g()}else keeperAPICall({command:API_COMMANDS.GET_DEVICE_TOKEN}).then(g);function g(d){d&&d.error&&d.result_code&&"invalid_client_version"==d.result_code?a&&a(d):(d&&(bg.set("encryptedDeviceToken",d.encryptedDeviceToken),localStorage.setItem("encryptedDeviceToken",d.encryptedDeviceToken.toString())),keeperAPICall({command:API_COMMANDS.PRE_LOGIN,uname:e}).then(function(d){if(d.error&&"region_redirect"===d.error)return KEEPERSECURITY_HOST=d.region_host,API_URL="https://"+KEEPERSECURITY_HOST+"/api/rest/vault/execute_v2_command",DATA_VAULT_URL="https://"+KEEPERSECURITY_HOST+"/vault/",CONSOLE_URL="https://"+KEEPERSECURITY_HOST+"/console/",PRE_LOGIN_URL="https://"+KEEPERSECURITY_HOST+"/api/rest/authentication/pre_login",DEVICE_TOKEN_URL="https://"+KEEPERSECURITY_HOST+"/api/rest/authentication/get_device_token",MASTER_PASSWORD_REENTRY_ACTION_TYPE_URL="https://"+KEEPERSECURITY_HOST+"/api/rest/authentication/validate_master_password",void Login({username:e,password:t,logintype:n,offlineErrorCallback:o,login_callback:a,rememberEmail:r,totp:s,suppressPopupRemoval:i,dtoken:c,noLoginVault:l});if(d.error)a&&a(d);else{bg.set("protoSaltArray",d.salt);var u=0,g={length:d.salt.length-1,currentIndex:u};bg.set("logintype",getLoginType(d.salt[u].name)),bg.set("authSalt",d.salt[u].salt),bg.set("authIterations",d.salt[u].iterations),g.currentIndex=u,doLoginAPIRequest({username:e,password:t,logintype:bg.get("logintype"),offlineErrorCallback:o,login_callback:a,rememberEmail:r,totp:s,suppressPopupRemoval:i,dtoken:c,noLoginVault:l,checkForAuthFailed:function n(){u++;g.currentIndex=u;bg.set("logintype",getLoginType(d.salt[u].name));bg.set("authSalt",d.salt[u].salt);bg.set("authIterations",d.salt[u].iterations);doLoginAPIRequest({username:e,password:t,logintype:bg.get("logintype"),offlineErrorCallback:o,login_callback:a,rememberEmail:r,totp:s,suppressPopupRemoval:i,dtoken:c,noLoginVault:l,checkForAuthFailed:n,saltArrayInfo:g})},saltArrayInfo:g})}}).catch(function(e){logger({data:"PRE_LOGIN"+e,consoleFunction:console.error}),Logout(null,null,!0)}))}}function ssoLogin(e,t,n){function o(e){try{return new URL(e).origin}catch(e){return""}}bg.get("isLoggedIn")||o(t)!==o(bg.get("sso_security_provider_url"))||"success"!==e.result||(bg.set("device_token_expire_days",e.tokenExpiry),bg.set("logintype",LoginType.SSO),loginExtension({login:e.email,password:e.password,totp:e.token,callback:function(t){"success"===t.result?(localStorage.ssoServiceProvider=e.provider_name,bg.set("isSsoUser",!0),closeTab(n),bg.set("sso_security_provider_url",null)):"Failed_to_find_user"===t.result_code?(openSsoRegistrationVault(e),closeTab(n)):"auth_expired_transfer"===t.result_code?(bg.set("isSsoUser",!0),bg.set("authExpired",!0),sendMessage("requestResponse",{request:"sso_login",response:t},n)):t.result||"user_does_not_exist"!=t.error?sendMessage("requestResponse",{request:"sso_login",response:t},n):(closeTab(n),openVault())}}))}function closeTab(e){"undefined"!=typeof chrome&&chrome.tabs&&chrome.tabs.remove&&chrome.tabs.remove(e)}function getSsoProvider(e,t){doSendAPIRequest({command:"get_sso_service_provider",name:e.toLowerCase().replace(/\s/g,"")},function(n){"region_redirect"===n.result_code?(KEEPERSECURITY_HOST=n.region_host,API_URL="https://"+KEEPERSECURITY_HOST+"/api/rest/vault/execute_v2_command",DATA_VAULT_URL="https://"+KEEPERSECURITY_HOST+"/vault/",CONSOLE_URL="https://"+KEEPERSECURITY_HOST+"/console/",REST_AUTHENTICATION="https://"+KEEPERSECURITY_HOST+"/api/rest/authentication/",PRE_LOGIN_URL="https://"+KEEPERSECURITY_HOST+"/api/rest/authentication/pre_login",DEVICE_TOKEN_URL="https://"+KEEPERSECURITY_HOST+"/api/rest/authentication/get_device_token",MASTER_PASSWORD_REENTRY_ACTION_TYPE_URL="https://"+KEEPERSECURITY_HOST+"/api/rest/authentication/validate_master_password",getSsoProvider(e,t)):t(n)},function(e,t){bg.accessingSSOLogin=!0,t&&t(e)})}function duoSelection(e,t,n){KeeperAPI.PBKDF2_SHA256(n||bg.get("pass"),bg.get("authSalt"),bg.get("authIterations")).then(function(n){doSendAPIRequest({command:"login",version:"2",auth_response:doubleHashAuth(n),"2fa_mode":e,"2fa_type":"one_time"},function(e){t(e)},function(e,t){t&&t(e)})})}function changeMasterPassword(e,t,n){var o=CryptoJS.lib.WordArray.random(16).toString(CryptoJS.enc.URLBase64);KeeperAPI.authVerifier(e,o,t).then(function(a){KeeperAPI.encryptEncryptionKey(e,t).then(function(r){doSendAPIRequest({command:"change_master_password",auth_verifier:a,encryption_params:r},function(a){"success"===a.result&&(bg.set("authIterations",t),bg.set("authSalt",o),bg.set("encryption_params",r),bg.set("password",e)),"function"==typeof n&&n(a)})})})}function saveDeviceToken(e,t){e?localSetting.setItem("dtokens",e,t):localSetting.removeItem("dtokens",t)}function getDeviceToken(e){return localSetting.getItem("dtokens",e)||bg.get("deviceToken")}function openSsoRegistrationVault(e){var t=btoa(JSON.stringify(e)),n="#email/"+e.email+"/",o="provider_name/"+encodeURI(e.provider_name)+"/",a=DATA_VAULT_URL+n+o+("login_token/"+t);"undefined"!=typeof chrome&&chrome.tabs.query({url:DATA_VAULT_URL},function(e){if(e.length>0){var t=e[0];chrome.tabs.update(t.id,{url:DATA_VAULT_URL,active:!0},function(e){chrome.tabs.reload(e.id)})}else chrome.tabs.create({url:a,active:!0})})}function openVault(e,t){var n=e&&e.record_uid?`#detail/${e.record_uid}`:"",o=t?DATA_VAULT_URL+t:DATA_VAULT_URL+n;o&&"undefined"!=typeof chrome&&chrome.tabs.query({url:DATA_VAULT_URL},function(e){if(e.length>0){var t=e[0];chrome.tabs.update(t.id,{url:o,active:!0},function(e){chrome.tabs.reload(e.id)})}else chrome.tabs.create({url:o,active:!0})})}function getStorage(){return window.localStorage}function setTermsAndPrivacyAccepted(){let e=bg.get("remoteTerms","remotePrivacy");chrome.storage.local.set({terms_date:e.remoteTerms,privacy_date:e.remotePrivacy})}function checkTermsAndPrivacyAccepted(e){if(localStorage.terms_date||localStorage.privacy_date){var t={terms_date:localStorage.terms_date,privacy_date:localStorage.privacy_date};chrome.storage.local.set(t,function(){localStorage.removeItem("terms_date"),localStorage.removeItem("privacy_date")}),n(t)}else chrome.storage.local.get(["terms_date","privacy_date"],n);function n(t){let n=bg.get("remoteTerms","remotePrivacy");n.remoteTerms&&n.remotePrivacy?e(t.terms_date>=n.remoteTerms&&t.privacy_date>=n.remotePrivacy):getTosDates(function(o){e(!o||t.terms_date>=n.remoteTerms&&t.privacy_date>=n.remotePrivacy)})}}function getYubikeyU2fChallenge(){var e=localSetting.getItem("expire_index",bg.get("temp_login"))||0;return e=[0,30,9999][e]||0,{u2f_challenge:obj.get("yubikey_u2f_challenge"),expireToken:e}}function getTosDates(e){var t=new XMLHttpRequest;function n(e,t){var n=e.match(new RegExp(t+"=([0-9]+)"));return n&&n[1]}t.open("GET",TOS_PP_INFO_URL),t.onload=function(){bg.set("remoteTerms",n(this.response,"terms2")),bg.set("remotePrivacy",n(this.response,"privacy2")),logger({data:"termsDate"+bg.get("remoteTerms"),consoleFunction:console.log}),logger({data:"privacyDate"+bg.get("remotePrivacy"),consoleFunction:console.log}),e&&e(!0)},t.onerror=function(){e&&e(!1)},t.send()}function cleanUpLastLogOutTimes(){var e=bg.get("lastLogOutTimes");Object.keys(e).forEach(t=>{const n=e[t];Date.now()-n>77777&&bg.delete("lastLogOutTimes."+t)})}function getCurrentTabId(){let e;return new Promise(function(t){"undefined"!=typeof chrome&&chrome.tabs.query({active:!0,lastFocusedWindow:!0},function(n){e=n&&n[0]&&n[0].id?n[0].id:null,t(e)})})}function handleIconClicked(){bg.get("isLoggedIn")&&getCurrentTabId().then(function(e){var t=bg.get("prompt_disabled_tabs"),n=t.indexOf(e);n>-1&&(t.splice(n,1),setLoggedInKeeperIcon(),sendMessage("startPromptInCurrentTab",{}))})}function setDisabledKeeperIcon(){"undefined"!=typeof chrome&&chrome.browserAction.setIcon({path:{19:"19-disabled.png",38:"38-disabled.png"}})}function setLoggedInKeeperIcon(){"undefined"!=typeof chrome&&chrome.browserAction.setIcon({path:{19:"19-active.png",38:"38-active.png"}})}function sendMessageToAllTabs(e,t){const n={name:e,data:t};"undefined"!=typeof chrome&&chrome.tabs.query({},function(o){o.forEach(function(o){chrome.tabs.sendMessage(o.id,n),logger({group:"Message Sent to All Tabs from Background",name:e,data:t,whichMessages:{csMessages:!0},consoleFunction:console.log}),chrome.runtime.lastError})})}function sendMessageToAllVaultTabs(e,t,n){const o={name:e,data:t};"undefined"!=typeof chrome&&chrome.tabs.query({},function(a){a.forEach(function(a){a.url.indexOf(DATA_VAULT_URL)>-1&&("loggedOut"===o.name?(chrome.tabs.sendMessage(a.id,o,function(e){chrome.runtime.lastError,n(e)}),logger({name:e,data:t,whichMessages:{vaultMessages:!0},consoleFunction:console.log})):(chrome.tabs.sendMessage(a.id,o),logger({name:e,data:t,whichMessages:{vaultMessages:!0},consoleFunction:console.log}),chrome.runtime.lastError))})})}function sendMessage(e,t,n,o,a){var r;"function"==typeof n&&(o=n),r=e?{name:e,data:t}:{data:t},"undefined"==typeof chrome||isFirefox?"undefined"!=typeof browser&&(n?(browser.tabs.sendMessage(n,r,function(e){o&&o(e)}),logger({group:"Message Sent to Tab number "+n+" from Background",name:e,data:t,whichMessages:{csMessages:!0},consoleFunction:console.log})):a?chrome.tabs.query({lastFocusedWindow:!0,active:!0},function(n){n.length&&(browser.tabs.sendMessage(n[0].id,r).then(function(e){browser.runtime.lastError,o&&o(e)}),logger({group:"Message Sent to Tab number "+n[0].id+" from Background",name:e,data:t,whichMessages:{csMessages:!0},consoleFunction:console.log}))}):browser.tabs.query({active:!0,currentWindow:!0},function(n){n.length&&(browser.tabs.sendMessage(n[0].id,r).then(function(e){browser.runtime.lastError,o&&o(e)}),logger({group:"Message Sent to Tab number "+n[0].id+" from Background",name:e,data:t,whichMessages:{csMessages:!0},consoleFunction:console.log}))})):n?(chrome.tabs.sendMessage(n,r,function(e){chrome.runtime.lastError,o&&o(e)}),logger({group:"Message Sent to Tab number "+n+" from Background",name:e,data:t,whichMessages:{csMessages:!0},consoleFunction:console.log}),chrome.runtime.lastError):a?chrome.tabs.query({lastFocusedWindow:!0,active:!0},function(n){n.length&&(chrome.tabs.sendMessage(n[0].id,r,function(e){chrome.runtime.lastError,o&&o(e)}),logger({group:"Message Sent to Tab number "+n[0].id+" from Background",name:e,data:t,whichMessages:{csMessages:!0},consoleFunction:console.log}))}):chrome.tabs.query({active:!0,currentWindow:!0},function(n){n.length&&(chrome.tabs.sendMessage(n[0].id,r,function(e){chrome.runtime.lastError,o&&o(e)}),logger({group:"Message Sent to Tab number "+n[0].id+" from Background",name:e,data:t,whichMessages:{csMessages:!0},consoleFunction:console.log}))})}var messageCallbacks=new function(){var e={};this.register=(t=>{const n="k-"+Math.random().toString(36).substr(2);return e[n]=t,n}),this.invoke=((t,...n)=>{var o=e[t];o&&(delete e[t],o(...n))})};function checkForRepeatingEvents(e,t){let n=Date.now()-t.lastEventTimestamp;t.lastEventTimestamp=Date.now(),n<=t.eventHighVolumeThreshold?t.howLongHaveWeBeenReceivingHightEventVolume+=n:t.howLongHaveWeBeenReceivingHightEventVolume=0,t.howLongHaveWeBeenReceivingHightEventVolume>=t.highVolumeTimeLimit&&logWithTabInfo("BG is experiencing a very high event volume!"),e!==t.lastRecievedEventName?(t.lastRecievedEventName=e,t.repeatedEventCount=0):(t.repeatedEventCount+=1,t.repeatedEventCount>=50&&logWithTabInfo(`BG is receiving repeating events! ${JSON.stringify(e,null,2)}`))}function logWithTabInfo(e){"undefined"!=typeof chrome?chrome.tabs.query({},t=>{let n=JSON.stringify(t,(e,t)=>/active|status|title|url|windowid/i.test(e)||!Number.isNaN(e)&&void 0!=e&&"object"==typeof t?t:void 0,2);logger({data:e+"\n====================\n"+`Tab count: ${t.length}\n`+`Tab info: ${n}`,consoleFunction:console.log})}):logger({data:e,consoleFunction:console.log})}var GetMessageHandler={},SetMessageHandler={},ActionMessageHandler={};if(GetMessageHandler.masterPasswordReEntry=function(e,t){var n=bg.get("enforcements");if(n&&n.master_password_reentry){var o=t.params.data;if(n.master_password_reentry.operations.find(e=>e==o.action))if(resetMPReentryTimeout(),bg.get("MPReentryEnabled"))return bg.set("masterPasswordReEntryCase",!0),bg.set("toolbarIconInterval",intervalToolbarIcon()),bg.set("MPReentryFromIframe",o.fromIframe),bg.set("MPReentryCloseWindow",o.closeWindow),bg.set("MPReEntryAction",o.action),!1}return!0},GetMessageHandler.inject_locks_data=function(e,t){var n=e.get("settings","isLoggedIn");return n.syncComplete=0!==getSyncRevision(),n.settings=deepClone(n.settings),n},GetMessageHandler.try_to_prompt_data=function(e,t){var n=bg.get("settings","isLoggedIn");return n.settings=deepClone(n.settings),n},GetMessageHandler.mutation_observer_data=function(e,t){var n=e.get("settings","isLoggedIn");return n.settings=deepClone(n.settings),n},GetMessageHandler.lastFillTimeOnInputField=function(e,t){return lastFillTimeOnInputField(t.params.data)},GetMessageHandler.settings=function(e,t){return getSettings()},GetMessageHandler.enforcements=function(e,t){return e.get("enforcements")},GetMessageHandler.isLoggedIn=function(e,t){return e.get("isLoggedIn")},GetMessageHandler.username=function(e,t){return e.get("uname")},GetMessageHandler.promptableLoginData=function(e,t){var n={};return e.get("promptableLoginData")&&domainFromURL(t.url)===domainFromURL(e.get("promptableLoginData.link"))?n=e.get("promptableLoginData","loginMatchingRecords"):(e.set("promptableLoginData",null),e.set("loginMatchingRecords",null)),n},GetMessageHandler.customFieldFillData=function(e,t){var n={};if(e.get("isLoggedIn")){var o=e.get("tryCustomFillRecord"),a=o.record;o.matchedFields;n={record:a||null}}else n.record=null;return n},GetMessageHandler.theme=function(e,t){return getTheme()},GetMessageHandler.getLocationOfTopWindow=function(e,t){return isEdge&&e.doNotPrompt?null:!0!==e.doNotPrompt[t.tabId]?t.senderUrl:null},GetMessageHandler.isSsoPage=function(e,t){return isEdge?!!e.doNotPrompt:!!e.doNotPrompt[t.tabId]},GetMessageHandler.autoFillRecord=function(e,t){var n=e.get("autoFillRecord");if(setupNoFilling(),n&&n.record&&n.record.extra&&n.record.extra.fields){const e=(n=JSON.parse(JSON.stringify(n))).record.extra.fields||[];n.record.custom=appendTotpToCustom(n.record.custom,e)}var o=n&&n.record&&n.record.link;return{displayMode:"record",autoFillRecord:"object"==typeof n&&0===t.url.indexOf("https:")&&domainFromURL(t.url)===domainFromURL(o)?n&&n.record:null,fromFrame:!1,doNotFillForATime:bg.get("doNotFillForATime")}},GetMessageHandler.lastLogOutTime=function(e,t){var n=t.url||"";return n=domainFromURL(n),cleanUpLastLogOutTimes(),e.get("lastLogOutTimes."+n)||null},GetMessageHandler.records=function(e,t){const n=getUrlMatchedRecords(t.params.data&&t.params.data.referrer||"");n&&n[0];return e.get("isLoggedIn")?n:null},GetMessageHandler.urlMatchedRecords=function(e,t){if(extensionIframeID()!==t.url)return;if(!e.get("isLoggedIn")||!e.getCache)return null;var n=deepClone(e.getCacheProp("profile")),o=n.addresses||[],a=n.cards||[],r=n.phone||[],s=(o.map(e=>(e.phone&&(e.phone=r.find(t=>t.uid===e.phone)||{uid:""}),e.country||(e.country=""),e)),a.map(e=>{var t=cardValidator.number(e.ccn);return e.type=t.card&&t.card.type||"",e.niceType=t.card&&t.card.niceType||"",e.ccn&&(e.ccn=e.ccn.substr(-4)),e.ccv&&(e.ccv="masked"),e.billing_address&&(e.billing_address=o.find(t=>t.uid===e.billing_address)||{uid:""}),e})),i=e.getCacheProp("profile.default_payment");if(s&&i&&s.length>1&&i.length>0)for(var c=0;c<s.length;c++)if(s[c].uid==i){var l=s.splice(c,1)[0];s.unshift(l);break}return{records:getUrlMatchedRecords(t.params.data.referrer,null,t.params.data.inPageEmail),addresses:o,cards:s,phone:r}},GetMessageHandler.allCardsAndAddresses=function(e,t){if(extensionIframeID()===t.url){if(!e.get("isLoggedIn")||!e.getCache)return null;var n=deepClone(e.getCacheProp("profile")),o=n.addresses||[],a=n.cards||[],r=n.phone||[],s=(o.map(e=>(e.phone&&(e.phone=r.find(t=>t.uid===e.phone)||{uid:""}),e.country||(e.country=""),e)),a.map(e=>{var t=cardValidator.number(e.ccn);return e.type=t.card&&t.card.type||"",e.niceType=t.card&&t.card.niceType||"",e.ccn&&(e.ccn=e.ccn.substr(-4)),e.ccv&&(e.ccv="masked"),e.billing_address&&(e.billing_address=o.find(t=>t.uid===e.billing_address)||{uid:""}),e})),i=e.getCacheProp("profile.default_payment");if(s&&i&&s.length>1&&i.length>0)for(var c=0;c<s.length;c++)if(s[c].uid==i){var l=s.splice(c,1)[0];s.unshift(l);break}return{addresses:o,cards:s,phone:r}}},GetMessageHandler.secureCardInfo=function(e,t){if(extensionIframeID()===t.url){var n={},{uid:o,key:a}=t.params.data;Array.isArray(a)||(a=[t.params.data.key]);var r=(e.getCacheProp("profile.cards")||[]).filter(function(e){return e.uid===o})[0];if(r)return a.forEach(function(e){r[e]&&(n[e]=r[e])}),n}},GetMessageHandler.getDataById=function(e,t){if(extensionIframeID()!==t.url)return;var n=t.params.data&&t.params.data.id||"";return{payload:getDataById(n)}},GetMessageHandler.lastRecordClicked=function(e,t){let n=e.get("lastRecordClicked");if(n&&n.extra&&n.extra.fields){const e=n.extra.fields||[];n.custom=appendTotpToCustom(n.custom,e)}return n&&t.params.data&&domainFromURL(t.params.data.from)===domainFromURL(n.link)?(e.set("lastRecordClicked",null),n):null},GetMessageHandler.disable_tab=function(e,t){let n=e.get("prompt_disabled_tabs").indexOf(t.tabId);return t.tabId&&n>-1?e.get("prompt_disabled_tabs")[n]:null},GetMessageHandler.changePasswordPending=function(e,t){var n=bg.get("changePasswordPending");return n&&domainFromURL(n.link)!==domainFromURL(t.url)&&bg.set("changePasswordPending",null),bg.get("changePasswordPending")},GetMessageHandler.isSsoUser=function(e,t){return bg.get("isSsoUser")},GetMessageHandler.whichTabIsHighlighted=function(e,t){return bg.get("whichTabIsHighlighted")},GetMessageHandler.isNotAppendedToLock=function(e,t){return localSetting&&localSetting.getItem("appendRecordListToLock")},GetMessageHandler.newTotpToken=function(e,t){if(extensionIframeID()!==t.url)return;const n=t.params.params;return generateTotpToken(n)},GetMessageHandler.asmCrypto=function(e,t){if(t.params&&t.params.data&&asmCrypto[t.params.data.name])return asmCrypto[t.params.data.name](t.params.data.value);if(t.params&&t.params.data&&"AES_GCM.encrypt"===t.params.data.name){var{bytes:n,key:o,iv:a}=t.params.data.value;return n instanceof Uint8Array||(n=Uint8Array.from(Object.values(n))),o instanceof Uint8Array||(o=Uint8Array.from(Object.values(o))),a instanceof Uint8Array||(a=Uint8Array.from(Object.values(a))),asmCrypto.AES_GCM.encrypt(n,o,a)}if(t.params&&t.params.data&&"AES_GCM.decrypt"===t.params.data.name){var{ciphertext:r,key:o,iv:a}=t.params.data.value;return r instanceof Uint8Array||(r=Uint8Array.from(Object.values(r))),o instanceof Uint8Array||(o=Uint8Array.from(Object.values(o))),a instanceof Uint8Array||(a=Uint8Array.from(Object.values(a))),asmCrypto.AES_GCM.decrypt(r,o,a)}},SetMessageHandler.vaultSSOPage=function(e,t){t.params.data;e.get("isLoggedIn")||(isEdge?bg.doNotPrompt=!0:bg.doNotPrompt[t.tabId]=!0,setTimeout(function(){isEdge?bg.doNotPrompt=!1:delete bg.doNotPrompt[t.tabId]},5e3))},SetMessageHandler.clearPromptableLoginData=function(e,t){e.get("promptableLoginData")&&(e.set("promptableLoginData",null),e.set("loginMatchingRecords",null))},SetMessageHandler.promptableLoginData=function(e,t){if(e.get("isLoggedIn")&&e.get("settings.savePrompt")){var n,o=t.params.data;const a=getUrlMatchedRecords(t.params.data.link);if(n=a.filter(function(e){return e.secret1===o.login&&e.secret2===o.password}),loginMatchingRecords=a.filter(function(e){return e.secret1===o.login&&e.secret2!==o.password}),n.length>0)return;1===loginMatchingRecords.length?(o.record_uid=loginMatchingRecords[0].record_uid,e.set("promptableLoginData",o),e.set("loginMatchingRecords",loginMatchingRecords)):e.set("promptableLoginData",o)}},SetMessageHandler.setAutoFill=function(e,t){t.params.data&&t.params.data.fillOnce?e.get("autoFilledOnce")?(e.set("autoFillRecord",void 0),e.set("autoFilledOnce",null)):(e.set("autoFillRecord",t.params.data.record),e.set("autoFilledOnce",!0)):e.set("autoFillRecord",t.params.data.record)},SetMessageHandler.successfulAutoFill=function(e,t){"object"==typeof e.get("autoFillRecord")&&e.set("autoFillRecord",void 0)},SetMessageHandler.uploadRecord=function(e,t,n){var o={},a=t.params.data;delete a.oldPassword,delete a.newPassword,a.record_uid&&(a=Object.assign({},getRecordById(a.record_uid),a)),uploadRecord(a,function(e,t){o=Object.assign(e,{record:t}),n(o)})},SetMessageHandler.updateNonSharedData=function(e,t,n){var{recordUid:o,changes:a}=t.params.data;updateNonSharedData(getRecordById(o),a,function(e){n&&n(e)})},SetMessageHandler.lastLogOutTime=function(e,t,n){var o=t.params.data&&t.params.data.url||"";(o=domainFromURL(o))&&e.set("lastLogOutTimes."+o,Date.now()),n(e.get("lastLogOutTimes."+o)),cleanUpLastLogOutTimes()},SetMessageHandler.setSmartfill=function(e,t,n){var o=t.params.data;o.record_uid&&(o=Object.assign({},getRecordById(o.record_uid),o)),uploadRecord(o,function(e,t){n&&n(t)})},SetMessageHandler.setTryCustomFillRecord=function(e,t){e.set("tryCustomFillRecord",{record:t.params.data.record,matchedFields:t.params.data.matchedFields})},SetMessageHandler.closeRecordListEventListener=function(e,t){sendMessage("closeRecordListEventListener",null,t.tabId)},SetMessageHandler.closeEditCreateMenuEventListener=function(e,t){sendMessage("closeEditCreateMenuEventListener",null,t.tabId)},SetMessageHandler.updateRecordLastFilled=function(e,t){var n=t.params.data&&t.params.data.record_uid;n&&updateRecordLastFilled(getRecordById(n),function(){})},SetMessageHandler.lastFillTimeOnInputField=function(e,t,n){lastFillTimeOnInputField(t.params.data,!0),n&&n()},SetMessageHandler.settings=function(e,t){extensionIframeID()===t.url&&updateSettings(t.params.data)},SetMessageHandler.addRecord=function(e,t,n){if(extensionIframeID()===t.url){var o=t.params.data;delete o.oldPassword,delete o.newPassword,o.record_uid&&(o=Object.assign({},getRecordById(o.record_uid),o)),uploadRecord(o,function(e,t){response=Object.assign(e,{record:t}),n&&n(response)})}},SetMessageHandler.addCard=function(e,t,n){if(extensionIframeID()===t.url){var o=Object.assign({},t.params.data),a=deepClone(e.getCacheProp("profile")||{revision:0});a.cards||(a.cards=[]);var r=a.name||a.profile_name||"",s=["addresses","phone","cards","default_payment","default_address","revision","profile_name"];for(var i of Object.keys(a))-1===s.indexOf(i)&&delete a[i];if(o.imageUrl&&delete o.imageUrl,o.uid){var c=a.cards.length;o=Object.assign({},getCardById(o.uid),o);for(var l=0;l<c&&a.cards[l].uid!==o.uid;l++);l===c?a.cards.push(o):a.cards.splice(l,1,o)}else o.uid="card-"+Math.random().toString(32).substring(2),a.cards.push(o);"object"==typeof o.billing_address&&"uid"in o.billing_address&&(o.billing_address=o.billing_address.uid);var d=o.expiration.split(/\//);2===d.length&&parseInt(d[0])<13&&2===d[1].length?(o.expiration="20"+d[1]+"/"+d[0],uploadPersonalInfo(r,JSON.stringify(a),function(t){"success"===t.result&&(auditEventLogging(o.uid,getCardById(o.uid)?"changed_payment_card":"added_payment_card",null,function(e){}),a.revision=t.revision,e.setCacheProp("profile",a),updateCachedProfileArrays()),t=Object.assign(t,{card:o}),n(t)})):(response={result:"fail",result_code:"date_invalid",message:"Credit card expiration date is invalid."},n(response))}},SetMessageHandler.addAddress=function(e,t,n){if(extensionIframeID()===t.url){var o=Object.assign({},t.params.data),a=deepClone(e.getCacheProp("profile")||{revision:0});a.addresses||(a.addresses=[]),a.phone||(a.phone=[]);var r=a.name||a.profile_name||"",s=["addresses","phone","cards","default_payment","default_address","revision","profile_name"];for(var i of Object.keys(a))-1===s.indexOf(i)&&delete a[i];if(o.phone&&o.phone.phone_number){let e=o.phone,t=getPhoneById(o.phone.uid)||a.phone.find(t=>t.country_code===e.country_code&&t.phone_number===e.phone_number);t?(e=Object.assign({},t,e),a.phone.splice(a.phone.indexOf(t),1,e)):(e.type="Mobile",e.uid="phone-"+Math.random().toString(32).substring(2),a.phone.push(e)),o.phone=e.uid}if(o.uid){var c=a.addresses.length;o=Object.assign({},getAddressById(o.uid),o);for(var l=0;l<c&&a.addresses[l].uid!==o.uid;l++);l===c?a.addresses.push(o):a.addresses.splice(l,1,o)}else o.uid="address-"+Math.random().toString(32).substring(2),a.addresses.push(o);uploadPersonalInfo(r,JSON.stringify(a),function(t){"success"===t.result&&(auditEventLogging(o.uid,getAddressById(o.uid)?"changed_identity":"added_identity",null,function(e){}),a.revision=t.revision,e.setCacheProp("profile",a),updateCachedProfileArrays()),t=Object.assign(t,{address:o}),n(t)})}},SetMessageHandler.enable_tab=function(e,t){-1===e.get("prompt_disabled_tabs").indexOf(t.tabId)&&setLoggedInKeeperIcon()},SetMessageHandler.disable_tab=function(e,t){let n=e.get("prompt_disabled_tabs");localStorage&&localStorage.getItem("disablePrompt")&&(t.tabId&&-1===n.indexOf(t.tabId)&&(n.push(t.tabId),e.set("prompt_disabled_tabs",n)),setDisabledKeeperIcon())},SetMessageHandler.lastRecordClicked=function(e,t){t&&t.params&&t.params.data&&t.params.data.record_id?e.set("lastRecordClicked",getRecordById(t.params.data.record_id)):e.set("lastRecordClicked",{})},SetMessageHandler.linkClicked=function(e,t){VaultMessaging.handleLinkClicked(t.params.data.record_id)},SetMessageHandler.frameFill=function(e,t,n){if(extensionIframeID()===t.url){var o=bg.get("MPReentryEnabled");bg.set("doNotFillForATime",!0),window.setTimeout(function(){bg.set("doNotFillForATime",!1)},5e3);var a=t.params.data;if(a&&a.payload&&a.payload.extra&&a.payload.extra.fields){const e=a.payload.extra.fields||[];a.payload.custom=appendTotpToCustom(a.payload.custom,e)}sendMessage("autoFill",a,t.tabId,function(t){t&&t.count&&t.count>0&&"object"==typeof e.get("autoFillRecord")&&e.set("autoFillRecord",void 0),n&&n(!o)})}},SetMessageHandler.encryptedMessage=function(e,t){VaultMessaging.handleEncryptedMessage(t.params.data.data)},SetMessageHandler.changePasswordPending=function(e,t,n){const o=t.params.data;bg.set("changePasswordPending",o),n(o)},SetMessageHandler.revertRecord=function(e,t,n){if(extensionIframeID()===t.url){var{record_uid:o}=t.params.data,a=getRecordById(o);getRecordHistory(o,function(e){var t={record_uid:o};t.record_key=bg.getCacheProp(`records.${o}.record_key`),t.record_key_type=bg.getCacheProp(`records.${o}.record_key_type`),t.revision=bg.getCacheProp(`records.${o}.revision`);for(var r=e.length-1;r>-1;r--){entry=e[r];try{var s=JSON.parse(KeeperAPI.decryptToString(entry.data,t.record_key||bg.get("encryptionKey")));if(t.folder=s.folder||"",t.title=s.title||"",t.secret1=s.secret1||"",t.secret2=s.secret2||"",t.link=s.link||"",t.notes=s.notes||"",t.custom=s.custom||[],t.secret2!=a.secret2){delete t.data;break}}catch(e){decryption_errors.push("Record decryption error, record ID "+t.record_uid+"\nError: "+e.message)}}if(t.extra)try{t.extra=JSON.parse(KeeperAPI.decryptToString(t.extra,t.record_key||bg.get("encryptionKey")))}catch(e){decryption_errors.push("Record Extra decryption error, record ID "+t.record_uid+"\nError: "+e.message)}else t.extra={};uploadRecord(t,function(e,t){bg.set("changePasswordPending",null),response=Object.assign(e,{record:t}),n(response)})})}},SetMessageHandler.whichTabIsHighlighted=function(e,t){const n=t.params.data;bg.set("whichTabIsHighlighted",n)},SetMessageHandler.lastInputField=function(e,t){bg.set("lastInputField",{readyInput:t.params.data.readyInput,frameUrl:new URL(t.url).origin,pageUrl:new URL(t.senderUrl).origin}),setChangedUrl(t.senderUrl)},ActionMessageHandler.remove_do_not_prompt=function(e,t){isEdge&&(e.doNotPrompt=!1)},ActionMessageHandler.showMPRentryErrorPopup=function(e,t){sendMessage("showMPRentryErrorPopup",null,t.tabId)},ActionMessageHandler.checkIfSSOLoginScreen=function(e,t,n){var o=t.params.data;notSSOLoginScreen(t.tabId,o)},ActionMessageHandler.handleVaultMessage=function(e,t,n){var o=t.params.data,a=t.tabId;Array.isArray(o)&&(o=Uint8Array.from(o)),VaultMessaging.handleVaultMessage(o,a,n)},ActionMessageHandler.vaultVersionCheck=function(e,t,n){var o=new XMLHttpRequest;o.open("GET",DATA_VAULT_URL+"?_="+(new Date).getTime()),o.onload=function(){isFirstVersionNumberGreaterThanSecondVersionNumber((new DOMParser).parseFromString(this.response,"text/html").querySelector('meta[name="version"]').content,t.params.data.versionNumber)&&chrome.browsingData.remove({origins:[DATA_VAULT_URL]},{appcache:!0,cache:!0,serviceWorkers:!0},function(){n(!0)})},o.send()},ActionMessageHandler.loginExtensionFromVault=function(e,t){var n=t.params.data;VaultMessaging.loginExtensionFromVault(n,t.tabId)},ActionMessageHandler.generateKeyPair=function(e,t,n){Promise.resolve().then(()=>{crypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:t.params.length,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]).then(e=>crypto.subtle.exportKey("jwk",e.privateKey)).then(e=>{e.n=base64urlsafe_to_hex(e.n),e.e=base64urlsafe_to_hex(e.e),e.d=base64urlsafe_to_hex(e.d),e.p=base64urlsafe_to_hex(e.p),e.q=base64urlsafe_to_hex(e.q),e.dp=base64urlsafe_to_hex(e.dp),e.dq=base64urlsafe_to_hex(e.dq),e.qi=base64urlsafe_to_hex(e.qi),n(e)})}).catch(e=>{logger({data:e,consoleFunction:console.error})})},ActionMessageHandler.requestResponse=function(e,t){var n=t.params.data,o=n.callbackId;messageCallbacks.invoke(o,n)},ActionMessageHandler.closeRecordList=function(e,t){sendMessage("closeRecordList",null,t.tabId)},ActionMessageHandler.closeEditCreateMenu=function(e,t){sendMessage("closeEditCreateMenu",null,t.tabId)},ActionMessageHandler.revertMovableHeader=function(e,t){extensionIframeID()===t.url&&sendMessage("revertMovableHeader")},ActionMessageHandler.showPromptFromFrame=function(e,t,n){var o=t.params.data||{};o.wantResponse?(o.props.bgListener=Math.random().toString(36).substr(2),sendMessage("showPrompt",o,t.tabId,function(e){n(e)})):sendMessage("showPrompt",o,t.tabId)},ActionMessageHandler.checkChangedPassword=function(e,t){var n=bg.get("changePasswordPending"),o=getRecordById(n.record_uid),a=t.params.data.props;a.record=o,sendMessage("checkChangedPassword",a,t.tabId)},ActionMessageHandler.showSaveOptions=function(e,t){sendMessage("showSaveOptions",t.params.data,t.tabId)},ActionMessageHandler.showExtensionFromFrame=function(e,t,n){sendMessage("showExtension",t.params.data,t.tabId,function(e){sendMessage("repositionOverlay",t.params.data,t.tabId),n&&n()})},ActionMessageHandler.showExtensionFromFrameByPrompt=function(e,t,n){sendMessage("showExtension",t.params.data,t.tabId,function(e){var o=localSetting&&localSetting.getItem("whichSide")?localSetting.getItem("whichSide"):"top-right",a=localSetting&&localSetting.getItem("fromWhere")?localSetting.getItem("fromWhere"):"slide";o&&a&&(t.params.data.whichSide=o,t.params.data.fromWhereID=a,t.params.data.fromPrompt=!0),sendMessage("repositionOverlay",t.params.data,t.tabId),n&&n()})},ActionMessageHandler.openFrame=function(e,t,n){sendMessage("openFrame",t.params.data,t.tabId,function(e){n(e)})},ActionMessageHandler.closeFrame=function(e,t){sendMessage("closeFrame",{},t.tabId)},ActionMessageHandler.updateFrameHeight=function(e,t){extensionIframeID()===t.url&&sendMessage("updateFrameHeight",t.params.data,t.tabId)},ActionMessageHandler.repositionFrame=function(e,t){if(extensionIframeID()===t.url){var n=localSetting&&localSetting.getItem("whichSide")?localSetting.getItem("whichSide"):"top-right",o=localSetting&&localSetting.getItem("fromWhere")?localSetting.getItem("fromWhere"):"slide";n&&o&&t.params.data?(t.params.data.whichSide=n,t.params.data.fromWhereID=o,sendMessage("repositionOverlay",t.params.data,t.tabId)):sendMessage("repositionOverlay",t.params.data,t.tabId)}},ActionMessageHandler.changePasswordReposition=function(e,t){extensionIframeID()===t.url&&sendMessage("changePasswordReposition",{},t.tabId)},ActionMessageHandler.toggleListenerForChangePasswordSubmission=function(e,t){extensionIframeID()===t.url&&sendMessage("toggleListenerForChangePasswordSubmission",t.params.data,t.tabId)},ActionMessageHandler.changePasswordFormSubmitted=function(e,t){sendMessage("changePasswordFormSubmitted",{},t.tabId)},ActionMessageHandler.frameFillField=function(e,t,n){extensionIframeID()===t.url&&sendMessage("fillField",t.params.data,t.tabId,function(e){e&&e.lockId?(sendMessage("repositionOverlay",e,t.tabId),n(e)):sendMessage("closeFrame",{},t.tabId)})},ActionMessageHandler.openVault=function(e,t){openVault()},ActionMessageHandler.removeSSOInfoBeforeGoingToVault=function(e,t,n){n()},ActionMessageHandler.openRecordInNewTab=function(e,t){extensionIframeID()===t.url&&openVault(t.params.data)},ActionMessageHandler.fillCustomFields=function(e,t,n){if(e.get("isLoggedIn")){var o=e.get("tryCustomFillRecord"),a=o&&o.record,r=o&&o.matchedFields;if(a&&a.extra&&a.extra.fields){const e=a.extra.fields||[];a.custom=appendTotpToCustom(a.custom,e)}sendMessage("tryFillCustomFields",{record:a,matchedFields:r},t.tabId,n)}},ActionMessageHandler.resetInactivityTimeout=function(e,t){t.params.data&&t.params.data.broadcast&&bg.get("isLoggedIn")&&sendMessage("inactivityTimeoutReset",{},t.tabId),resetInactivityTimeout()},ActionMessageHandler.editMode=function(e,t){sendMessage("editMode",t.params.data,t.tabId)},ActionMessageHandler.editDone=function(e,t){sendMessage("editDone",{},t.tabId)},ActionMessageHandler.roleEnforcementRestriction=function(e,t){sendMessage("roleEnforcementRestriction",{},t.tabId)},ActionMessageHandler.toggleHeaderButtons=function(e,t){extensionIframeID()===t.url&&sendMessage("toggleHeaderButtons",t.params.data,t.tabId)},ActionMessageHandler.toggleMoreIcon=function(e,t){extensionIframeID()===t.url&&sendMessage("toggleMoreIcon",t.params.data,t.tabId)},ActionMessageHandler.updateExtensionClasses=function(e,t){sendMessage("updateExtensionClasses",t.params.data,t.tabId)},ActionMessageHandler.changePasswordFlow=function(e,t){sendMessage("changePasswordFlow",t.params.data,t.tabId)},ActionMessageHandler.showChangePrompt=function(e,t){sendMessage("showChangePrompt",t.params.data,t.tabId)},ActionMessageHandler.updateLocksPayload=function(e,t){extensionIframeID()===t.url&&sendMessage("updateLocksPayload",t.params.data,t.tabId)},ActionMessageHandler.disableLocks=function(e,t){extensionIframeID()===t.url&&sendMessage("disableLocks",t.params.data,t.tabId)},ActionMessageHandler.restoreLocks=function(e,t){sendMessage("restoreLocks",t.params.data,t.tabId)},ActionMessageHandler.newPasswordFilled=function(e,t){sendMessage("newPasswordFilled",{},t.tabId)},ActionMessageHandler.oldPasswordFilled=function(e,t){sendMessage("oldPasswordFilled",{},t.tabId)},ActionMessageHandler.showCreateEditScreen=function(e,t){sendMessage("showCreateEditScreen",{itemType:t.params.itemType,edit:t.params.edit},t.tabId)},ActionMessageHandler.saySendMessage=function(e,t){sendMessage("showExtension",{},t.tabId)},ActionMessageHandler.yubikeyDuoSelection=function(e,t){duoSelection(t.params.data.mode,function(){},bg.get("temp_password"))},ActionMessageHandler.yubikey2faLogin=function(e,t,n){bg.set("device_token_expire_days",t.params.data.tokenExpValue),loginExtension({login:bg.get("temp_login"),password:bg.get("temp_password"),totp:t.params.data.totp,callback:function(e){n(e.result)}})},ActionMessageHandler.transitionPopupOut=function(e,t){extensionIframeID()===t.url&&sendMessage("transitionPopupOut",{},t.tabId)},ActionMessageHandler.logout=function(e,t){Logout()},ActionMessageHandler.ping=function(e,t){0===t.url.indexOf(DATA_VAULT_URL)&&sendMessageToAllVaultTabs("extensionAlive",{})},ActionMessageHandler.vaultLoaded=function(e,t){0===t.url.indexOf(DATA_VAULT_URL)&&(sendMessageToAllVaultTabs("extensionAlive",{}),sendMessageToAllVaultTabs("setTimeout",{timeout:getInactivityTimeout()}))},ActionMessageHandler.sso_login=function(e,t){ssoLogin(t.params.data,t.url,t.tabId)},ActionMessageHandler.duoSelection=function(e,t){duoSelection(t.params.data.mode,function(e){})},ActionMessageHandler.closeTab=function(e,t){closeTab(t.tabId)},ActionMessageHandler.loginThroughYubikey=function(e,t,n){var o=t.params.data?t.params.data:{};bg.set("device_token_expire_days",t.params.data.tokenExpValue),loginExtension({login:bg.get("temp_login"),password:bg.get("temp_password"),totp:o,callback:function(e){n(e.result)}})},ActionMessageHandler.giveRecordTotpInCustomForFilling=function(e,t,n){var o=t&&t.params&&t.params.data;if(o&&o.extra&&o.extra.fields){const e=o.extra.fields||[];o.custom=appendTotpToCustom(o.custom,e)}n(o)},ActionMessageHandler.confirmFromIframe=function(e,t,n){confirmFromIframe(t.params.message,t.params.lock,t.params.input,n)},isFirefox)function handleRequest(e,t){return new Promise((n,o)=>{checkForRepeatingEvents(e.name,t),e.params?"GET"===e.params.type&&"function"==typeof GetMessageHandler[e.name]?n(GetMessageHandler[e.name](bg,e)):"SET"===e.params.type&&"function"==typeof SetMessageHandler[e.name]?SetMessageHandler[e.name](bg,e,n):"ACTION"===e.params.type&&"function"==typeof ActionMessageHandler[e.name]?ActionMessageHandler[e.name](bg,e,n):"autoShowingExtensionPopup"!==e.name&&logger({data:"Unhandled message: "+e,consoleFunction:console.error}):logger({data:"Unhandled message: "+e,consoleFunction:console.error})})}else function handleRequest(e,t,n){checkForRepeatingEvents(e.name,t),e.params?"GET"===e.params.type&&"function"==typeof GetMessageHandler[e.name]?n(GetMessageHandler[e.name](bg,e)):"SET"===e.params.type&&"function"==typeof SetMessageHandler[e.name]?SetMessageHandler[e.name](bg,e,n):"ACTION"===e.params.type&&"function"==typeof ActionMessageHandler[e.name]?ActionMessageHandler[e.name](bg,e,n):"autoShowingExtensionPopup"!==e.name&&logger({data:"Unhandled message: "+e,consoleFunction:console.error}):logger({data:"Unhandled message: "+e,consoleFunction:console.error})}function backgroundMessagingSystem(){var e={lastRecievedEventName:"",repeatedEventCount:0,lastEventTimestamp:Date.now(),eventHighVolumeThreshold:500,howLongHaveWeBeenReceivingHightEventVolume:0,highVolumeTimeLimit:5e3};chrome.runtime.onMessage.addListener(function(t,n,o){return t=Object.assign(t,{url:n.url,tabId:n.tab.id,senderUrl:n.tab.url}),logger({group:"Content Scripts Message to Background",name:t.name,data:t,whichMessages:{csMessages:!0},consoleFunction:console.log}),isFirefox?Promise.resolve().then(()=>handleRequest(t,e)):(handleRequest(t,e,function(e){return o(e),!0}),!0)})}function openInNewTab(e){return e=getURL(e),new Promise(function(t,n){e&&chrome.tabs.query({url:e.href.includes("#browserextensionlogin")?e.href.replace("#browserextensionlogin",""):e.href},function(o){if(o.length>0){var a=o[0];chrome.tabs.update(a.id,{active:!0}),chrome.windows.getCurrent(function(e){e.id!==a.windowId&&chrome.windows.update(a.windowId,{focused:!0})}),n()}else chrome.tabs.create({url:e.href},function(e){t(e.id)})})})}function openVaultContextMenu(){var e=getLanguage();return openInNewTab(DATA_VAULT_URL+("en_US"===e?"":"#lang/"+e)+("en_US"===e?"#browserextensionlogin":"/#browserextensionlogin"))}function getURL(e){var t;if(e)try{t=new URL(e)}catch(n){0!==e.indexOf("http")&&(t=getURL("https://"+e.trim()))}return t}function KeeperAES256GCMdecrypt(e,t){var n=KeeperAES256GCMdecryptToBytes(e,t);return decodeURIComponent(escape(Array.prototype.map.call(n,function(e){return String.fromCharCode(e)}).join("")))}function KeeperAES256GCMencrypt(e,t){return encryptToBase64UrlSafe(e,t)}function encryptToBase64UrlSafe(e,t){return bytes_to_base64urlsafe(KeeperAES256GCMencryptToBytes(e,t))}function random_aes_256_iv(){return random(128)}function bytes_to_base64urlsafe(e){return asmCrypto.bytes_to_base64(e).replace(/=+$/g,"").replace(/\//g,"_").replace(/\+/g,"-")}function KeeperAES256decryptToBytes(e,t,n){if(e){t.__proto__==={}.__proto__&&(t=new Uint8Array(Object.values(t)));var o="string"==typeof e?base64urlsafe_to_bytes(e):e,a=o.subarray(0,16),r=o.subarray(16);return asmCrypto.AES_CBC.decrypt(r,t,!n,a)}}function KeeperAES256encryptToBytes(e,t,n){if(e){var o="string"==typeof e?utf8_to_bytes(e):e;if(!(o instanceof Uint8Array))throw new Error("Unhandled cleartext type");var a=random_aes_256_iv(),r=asmCrypto.AES_CBC.encrypt(o,t,!n,a),s=new Uint8Array(a.length+r.length);return s.set(a),s.set(r,a.length),s}}function decryptEncryptedClientKey(e,t,n,o){return new Promise((a,r)=>{Promise.resolve().then(()=>deriveDataClientEncryptionDecryptionKey(e,t,n)).then(e=>{try{return KeeperAES256GCMdecryptToBytes(o,e)}catch(e){a(e)}}).then(a).catch(r)})}function deriveDataClientEncryptionDecryptionKey(e,t,n,o){return new Promise((o,a)=>{"string"==typeof t&&(t=base64urlsafe_to_bytes(t));Promise.resolve().then(()=>KeeperAPI.PBKDF2_SHA512_Offline("data_key"+e,t,n)).then(e=>{return KeeperCryptohmac_sha256_to_bytes("data_key",base64urlsafe_to_bytes(e))}).then(o).catch(a)})}function KeeperCryptohmac_sha256_to_bytes(e,t){var n="string"==typeof e?utf8_to_bytes(e):e;return new asmCrypto.HmacSha256(t).process(n).finish().result}function decryptDataKey(e,t){var n;n=base64urlsafe_to_bytes(e);var o=16777215&new DataView(n.buffer,0,4).getUint32(0,!1),a=n.subarray(4,20);KeeperAPI.PBKDF2_SHA256(t,a,o).then(function(e){for(var t=base64urlsafe_to_bytes(e),o=KeeperAES256decryptToBytes(n.subarray(20),t,!0),a=o.subarray(0,32),r=o.subarray(32),s=0;s!=a.byteLength-1;s++)if(a[s]!=r[s])throw Exception("Oops decrypting go bad.");bg.set("offline_data_key",a)})}function pingKeeperApp(e){var t=new XMLHttpRequest;t.open("GET",PING_URL),t.responseType="text",t.onload=function(){setIsOffline(!1),e(!1)},t.onerror=function(){setIsOffline(!0),e(!0)},t.send()}function saveOfflineUserInSavedUsers(e,t){var n;(n=localStorage.savedUsers?JSON.parse(localStorage.savedUsers):{})[e]={hasOfflineDB:t},localStorage.savedUsers=JSON.stringify(n)}function appendTotpToCustom(e,t){if(t.length>0){var n={};t.forEach(t=>{if("totp"===t.field_type){n.name=t.field_type;try{n.value=generateTotpToken(generateTotpParams(t.data))}catch(e){n.value=""}e.unshift(n)}})}return e}function translateThis(e,t,n){return n=n||getLanguage(),translation[n]&&translation[n][e]?translation[n][e]:translation.en_US&&translation.en_US[e]?translation.en_US[e]:(logger({data:"missing translation key:"+e,consoleFunction:console.warn}),t||e)}function extensionIframeID(){return location.href.replace("background.html","content_scripts/prompt.html")}function isTopWindowURLTheFrameURL(e,t){return e===t}function isFirstVersionNumberGreaterThanSecondVersionNumber(e,t){if(e.includes(".")&&t.includes(".")){var n=parseInt(e.substr(0,e.indexOf("."))),o=parseInt(t.substr(0,t.indexOf("."))),a=e.slice(e.indexOf(".")+1),r=t.slice(t.indexOf(".")+1);return n>o||!(n<o)&&isFirstVersionNumberGreaterThanSecondVersionNumber(a,r)}return parseInt(e)>parseInt(t)}function initiateConnectionToVault(e){isChrome?(logger({group:"Extension to Vault",name:"connect",data:{cmd:"connect"},whichMessages:{vaultMessages:!0},consoleFunction:console.log}),chrome.tabs.sendMessage(e.id,{cmd:"connect"})):VaultMessaging.sendMessageToVault({cmd:"handshake"},e.id)}function getLoginType(e){switch(e){case"Master":return LoginType.NORMAL;case"sso":return LoginType.SSO;case"alternate":return LoginType.ALTERNATE;case"offline":return LoginType.OFFLINE;default:return 0}}function getExpireIndex(e){if(e)switch(e){case 0:return 0;case 30:return 1;case 9999:return 2}}function notSSOLoginScreen(e,t){(t.includes("sso-login")||t.includes("Sign into Keeper"))&&(isEdge?bg.doNotPrompt=!0:bg.doNotPrompt[e]=!0)}function intervalToolbarIcon(){var e=!1;return clearInterval(bg.get("toolbarIconInterval")),setInterval(function(){e?chrome.browserAction.setIcon({path:{19:"19-inactive.png",38:"38-inactive.png"}}):chrome.browserAction.setIcon({path:{19:"19-active.png",38:"38-active.png"}}),e=!e},1e3)}function clearIntervalToolbarIcon(){bg.get("isLoggedIn")?chrome.browserAction.setIcon({path:{19:"19-active.png",38:"38-active.png"}}):chrome.browserAction.setIcon({path:{19:"19-inactive.png",38:"38-inactive.png"}}),clearInterval(bg.get("toolbarIconInterval"))}function changeRestCalls(e){PRE_LOGIN_URL=e+"pre_login",DEVICE_TOKEN_URL=e+"device_token",MASTER_PASSWORD_REENTRY_ACTION_TYPE_URL=e+"validate_master_password"}function generatePasswordComplexities(e,t){var n=e.split(",");if(0===(n=_.compact(n.map(e=>{var n="",o=urlComponentJoiner(e.substring(0,e.indexOf("|")));return o.indexOf("*")>-1&&t.forEach(t=>{t.match(o.replace(/[.+?^${}()|[\]\\]/g,"\\$&").replace(/\*/g,".*"))&&(n=e.substring(e.indexOf("|")+1))}),t.forEach(t=>{t.includes(o)&&(n=e.substring(e.indexOf("|")+1))}),n}))).length)return null;var o={ruleLength:0,lc:0,uc:0,numbers:0,special:0,privacyScreen:0};return n.forEach(e=>{var t=e.split("|").map(e=>parseInt(e));o={ruleLength:t[0]>o.ruleLength?t[0]:o.ruleLength,lc:t[1]>o.lc?t[1]:o.lc,uc:t[2]>o.uc?t[2]:o.uc,numbers:t[3]>o.numbers?t[3]:o.numbers,special:t[4]>o.special?t[4]:o.special,privacyScreen:o.privacyScreen||t[5]?1:0}}),o}function urlComponentJoiner(e){if(!/^https?:\/\//.test(e)&&/(?:[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])/.test(e))return"";if(/^https?:\/\//.test(e)||(e="https://"+e),"https://"==e)return"";try{var{protocol:t,host:n,pathname:o,search:a}=new URL(e)}catch(t){return e}return t+="//",/[!@#$%^&*(),?":{}|<>]/i.test(n)&&(n=unescape(n)),[t,n.replace(/^www\./,""),o,a].slice(1,2).join("")}function getURLsFromCustomAndRecord(e){var t=[];return e&&(e.custom&&e.custom.length>0&&e.custom.forEach(e=>{var n=urlComponentJoiner(e.value);n&&t.push(n)}),e.link&&t.push(e.link)),t}function enforcePrivacyScreen(e,t){var n=generatePasswordComplexities(e,getURLsFromCustomAndRecord(t));return!(!n||!n.privacyScreen)}function setupNoFilling(){if(!bg.get("doNotFillForATimeTimerDuration")){setTimeout(function(){bg.set("doNotFillForATime",!0),window.setTimeout(function(){bg.set("doNotFillForATimeTimerDuration",!1),bg.set("doNotFillForATime",!1)},4e3)},1e3),bg.set("doNotFillForATimeTimerDuration",!0)}}backgroundMessagingSystem(),function(){if("undefined"!=typeof chrome){chrome.tabs.onActivated.addListener(function(e){bg.get("prompt_disabled_tabs").some(t=>t===e.tabId)?setDisabledKeeperIcon():bg.get("isLoggedIn")&&setLoggedInKeeperIcon()})}}(),window.alert=function(e){throw new Error(e)},function(){var e=window.setInterval(function(){"undefined"!=typeof keeper&&(window.clearInterval(e),legacyInit())},1)}(),cardValidator.creditCardType.addCard({niceType:"UATP",type:"uatp",patterns:[1],gaps:[3,7,11],lengths:[15],code:{name:"CVV",size:3}}),chrome.tabs.onActivated.addListener(e=>{e&&e.tabId&&e.windowId&&chrome.tabs.query({active:!0,lastFocusedWindow:!0},t=>{t&&Array.isArray(t)&&t.forEach(t=>{e.tabId!==t.id||e.windowId!==t.windowId||setChangedUrl(t.url)})})}),chrome.tabs.onUpdated.addListener((e,t,n)=>{t&&t.url&&setChangedUrl(t.url),Object.keys(bg.vault_logged_in_by_tab).forEach(function(e){e==n.id&&delete bg.vault_logged_in_by_tab[e]})}),chrome.tabs.onRemoved.addListener(function(e,t){delete bg.vault_port_by_tab[e],delete bg.vault_comm_keys_by_tab[e],delete bg.vault_priv_keys_by_tab[e],delete bg.vault_logged_in_by_tab[e],isEdge?bg.doNotPrompt=!1:delete bg.doNotPrompt[e]}),chrome.tabs.onActivated.addListener(function(e){isEdge||(bg.doNotPrompt={})});