function syncDown(e){function r(e){let r=bg.getCacheProp(`shared_folders.${e}`);r&&r.records&&r.records.forEach(function(e){sharedFoldersContainingRecord(e.record_uid).length>1||bg.deleteCacheProp(`records.${e.record_uid}`)}),bg.deleteCacheProp(`shared_folder_meta_data.${e}`),bg.deleteCacheProp(`shared_folders.${e}`)}doSendAPIRequest({command:"sync_down",client_time:Date.now(),device_id:bytes_to_base64urlsafe(bg.get("encryptedDeviceToken"))||"",revision:bg.getCache()?bg.getCacheProp("revision"):0,include:["sfheaders","sfrecords","sfusers","profile"]},function(d){var o=[];if("success"===d.result){if(!0!==d.full_sync&&bg.getCache()||bg.set("cache",{revision:0,records:{},phones:{},cards:{},addresses:{},record_meta_data:{},shared_folders:{},shared_folder_meta_data:{},teams:{},non_shared_data:{},profile:{},profile_pic:{},records_array:[]}),bg.setCacheProp("revision",d.revision),d.removed_teams&&d.removed_teams.forEach(function(e){bg.getCacheProp(`teams.${e}`)&&bg.getCacheProp(`teams.${e}.shared_folder_keys`)&&bg.getCacheProp(`teams.${e}.shared_folder_keys`).forEach(function(e){bg.getCacheProp(`shared_folder_meta_data.${e.shared_folder_uid}`)||teamsContainingSharedFolder(e.shared_folder_uid).length>1||r(e.shared_folder_uid)}),bg.deleteCacheProp(`teams.${e}`)}),d.removed_shared_folders&&d.removed_shared_folders.forEach(r),d.record_meta_data&&d.record_meta_data.forEach(function(e){if(e.record_key)try{e.record_key=KeeperAPI.decryptTypedKey(e.record_key,e.record_key_type)}catch(r){o.push("Record key decryption error, record ID "+e.record_uid+"\nError: "+r.message)}bg.setCacheProp(`record_meta_data.${e.record_uid}`,{can_edit:e.can_edit,can_share:e.can_share,owner:!!e.owner}),bg.setCacheProp(`records.${e.record_uid}`,Object.assign({},bg.getCacheProp(`records.${e.record_uid}`),{record_key:e.record_key,record_key_type:e.record_key_type,owner:!!e.owner}))}),d.non_shared_data&&d.non_shared_data.forEach(function(e){try{bg.setCacheProp(`non_shared_data.${e.record_uid}`,JSON.parse(KeeperAPI.decryptToString(e.data,bg.get("encryptionKey"))))}catch(r){o.push("Non Shared Data decryption error",e.record_uid),bg.setCacheProp(`non_shared_data.${e.record_uid}`,{})}}),d.teams&&d.teams.forEach(function(e){try{e.team_key=KeeperAPI.decryptTypedKey(e.team_key,e.team_key_type)}catch(r){return void o.push("Team key decryption error, team ID "+e.team_uid+"\nError: "+r.message)}var r=KeeperAPI.decryptToBytes(e.team_private_key,e.team_key).toString();e.team_private_key=new RSAKey;try{e.team_private_key.readPrivateKeyFromASN1HexString(r)}catch(r){return void o.push("Team key decryption error, team ID "+e.team_uid+"\nError: "+r.message)}e.shared_folder_keys.forEach(function(r){try{if(2===r.key_type){var d=KeeperAPI.Base64ToHex(r.shared_folder_key),a=e.team_private_key.decryptBinary(d);r.shared_folder_key=CryptoJS.enc.Hex.parse(a)}else r.shared_folder_key=KeeperAPI.decryptToBytes(r.shared_folder_key,e.team_key),r.shared_folder_key.clamp();bg.getCacheProp(`shared_folders.${r.shared_folder_uid}`)||bg.setCacheProp(`shared_folders.${r.shared_folder_uid}`,{shared_folder_key:r.shared_folder_key})}catch(d){delete r.shared_folder_key,o.push("Shared Folder key decryption error, Shared Folder ID "+r.shared_folder_uid+", Team ID "+e.team_uid+"\nError: "+d.message)}}),bg.setCacheProp(`teams.${e.team_uid}`,e)}),d.shared_folders&&d.shared_folders.forEach(function(e){if(e.shared_folder_key){bg.setCacheProp(`shared_folder_meta_data.${e.shared_folder_uid}`,{manage_records:e.manage_records,manage_users:e.manage_users});try{e.shared_folder_key=KeeperAPI.decryptTypedKey(e.shared_folder_key,e.key_type)}catch(r){return void o.push("Shared Folder key decryption error, shared folder ID "+e.shared_folder_uid+"\nError: "+r.message)}}else{if(!bg.getCacheProp(`shared_folders.${e.shared_folder_uid}`)||!bg.getCacheProp(`shared_folders.${e.shared_folder_uid}.shared_folder_key`))return;e.shared_folder_key=bg.getCacheProp(`shared_folders.${e.shared_folder_uid}.shared_folder_key`)}e.name=KeeperAPI.decryptToString(e.name,e.shared_folder_key),e.records_removed&&e.records_removed.forEach(function(r){if(bg.setCacheProp(`shared_folders.${e.shared_folder_uid}.records`,bg.getCacheProp(`shared_folders.${e.shared_folder_uid}.records`).filter(function(e){return e.record_uid!==r})),0===sharedFoldersContainingRecord(r).length){const e=bg.getCacheProp(`record_meta_data.${r}`);var d=bg.getCacheProp(`records.${r}`);e.owner?d.shared=!1:bg.deleteCacheProp(`records.${r}`)}}),e.records?e.records.forEach(function(r){try{r.record_key=KeeperAPI.decryptToBytes(r.record_key,e.shared_folder_key),bg.getCacheProp(`records.${r.record_uid}`)||bg.setCacheProp(`records.${r.record_uid}`,{record_key:r.record_key})}catch(e){o.push("Record key decryption error, record ID "+r.record_uid+"\nError: "+e.message)}}):e.records=[],e.users||(e.users=[]),e.teams||(e.teams=[]),e.full_sync||!bg.getCacheProp(`shared_folders.${e.shared_folder_uid}`)?bg.setCacheProp(`shared_folders.${e.shared_folder_uid}`,e):(e.records=mergedSharedFolderRecords(e.shared_folder_uid,e.records),e.users=mergedSharedFolderUsers(e.shared_folder_uid,e.users),e.teams=mergedSharedFolderTeams(e.shared_folder_uid,e.teams),bg.setCacheProp(`shared_folders.${e.shared_folder_uid}`,e))}),d.removed_records&&d.removed_records.forEach(function(e){bg.deleteCacheProp(`record_meta_data.${e}`),0===sharedFoldersContainingRecord(e).length&&(bg.deleteCacheProp(`non_shared_data.${e}`),bg.deleteCacheProp(`records.${e}`))}),d.records&&d.records.forEach(function(e){if(bg.getCacheProp(`records.${e.record_uid}`)){e.record_key=bg.getCacheProp(`records.${e.record_uid}.record_key`),e.record_key_type=bg.getCacheProp(`records.${e.record_uid}.record_key_type`);try{var r=JSON.parse(KeeperAPI.decryptToString(e.data,e.record_key||bg.get("encryptionKey")));e.folder=r.folder||"",e.title=r.title||"",e.secret1=r.secret1||"",e.secret2=r.secret2||"",e.link=r.link||"",e.notes=r.notes||"",e.custom=r.custom,e.custom||(e.custom=[]),delete e.data}catch(r){o.push("Record decryption error, record ID "+e.record_uid+"\nError: "+r.message)}if(e.extra)try{e.extra=JSON.parse(KeeperAPI.decryptToString(e.extra,e.record_key||bg.get("encryptionKey")))}catch(r){o.push("Record Extra decryption error, record ID "+e.record_uid+"\nError: "+r.message)}else e.extra={};bg.setCacheProp(`records.${e.record_uid}`,e)}else o.push("No record key for "+e.record_uid)}),d.profile)try{var a=JSON.parse(KeeperAPI.decryptToString(d.profile.data,bg.get("encryptionKey")));if(bg.setCacheProp("profile",a),bg.setCacheProp("profile.profile_name",d.profile.profile_name),bg.setCacheProp("profile.revision",d.profile.revision),updateCachedProfileArrays(),"phone"in bg.getCacheProp("profile")){var t=[];for(var s in bg.getCacheProp("phones"))t.push(bg.getCacheProp(`phones.${s}`));bg.setCacheProp("phone",t)}}catch(e){o.push("Error decrypting profile.\nError: "+e.message)}d.profile_pic&&bg.setCacheProp("profile_pic",d.profile_pic),updateCachedRecordArray()}sendMessage("syncComplete",{}),sendMessage("syncCompleteActiveTab",{}),e&&e(d,o)})}function teamsContainingSharedFolder(e){var r=[];let d=bg.getCacheProp("teams");for(var o in d){-1!==d[o].shared_folder_keys.map(function(e){return e.shared_folder_uid}).indexOf(e)&&r.push(o)}return r}function sharedFoldersContainingRecord(e){var r=[];let d=bg.getCacheProp("shared_folders");for(var o in d){-1!==d[o].records.map(function(e){return e.record_uid}).indexOf(e)&&r.push(o)}return r}function mergedSharedFolderRecords(e,r){return mergeItems(Object.assign({},bg.getCacheProp(`shared_folders.${e}`)).records,r,"record_uid")}function mergedSharedFolderUsers(e,r){return mergeItems(Object.assign({},bg.getCacheProp(`shared_folders.${e}`)).users,r,"username")}function mergedSharedFolderTeams(e,r){return mergeItems(Object.assign({},bg.getCacheProp(`shared_folders.${e}`)).teams,r,"team_uid")}function mergeItems(e,r,d){return r.forEach(function(r){for(var o=0;o<e.length;o++)if(e[o][d]===r[d])return void(e[o]=r);e.push(r)}),e}function getDataById(e){var r=deepClone(getRecordById(e)||getCardById(e)||getAddressById(e)||getPhoneById(e));return r&&r.billing_address&&"string"==typeof r.billing_address?r.billing_address=getAddressById(r.billing_address):r&&r.phone&&"string"==typeof r.phone&&(r.phone=getPhoneById(r.phone)),r.hasOwnProperty("country_code")&&""===r.country_code&&(r.country_code="US",r.country="United States"),r}function getCardById(e){return bg.getCacheProp(`cards.${e}`)||null}function getAddressById(e){return bg.getCacheProp(`addresses.${e}`)||null}function getPhoneById(e){return bg.getCacheProp(`phones.${e}`)||null}function getRecordById(e){var r=bg.getCacheProp(`records.${e}`),d=bg.getCacheProp(`record_meta_data.${e}`),o=bg.getCacheProp(`non_shared_data.${e}`);if(r&&o&&(r.non_shared_data=o),r&&r.owner)return Object.assign({},r,d,{can_view:!0,can_edit:!0});if(r&&d)return Object.assign({},r,d,{can_view:!0});if(r){var a=!1,t=!0,s=!0,c=!0;return sharedFoldersContainingRecord(e).forEach(function(r){a||(bg.getCacheProp(`shared_folder_meta_data.${r}`)?bg.getCacheProp(`shared_folders.${r}.records`).forEach(function(o){o.record_uid===e&&(o.can_view=!0,(d=o).shared_folder_uid=r,a=o.can_edit&&o.can_share)}):(teamsContainingSharedFolder(r).forEach(function(e){var r=bg.getCacheProp(`teams.${e}`);!1===r.restrict_edit&&(t=!1),!1===r.restrict_share&&(s=!1),!1===r.restrict_view&&(c=!1)}),bg.getCacheProp(`shared_folders.${r}.records`).forEach(function(o){o.record_uid===e&&(o.can_view=!0,t&&(o.can_edit=!1),s&&(o.can_share=!1),c&&(o.can_view=!1),(d=o).shared_folder_uid=r,a=o.can_edit&&o.can_share)})))}),Object.assign({},r,d)}return null}function getRecordsAsArray(){let e=bg.getCache();return e?e.records_array:[]}function getOwnedRecordsAsArray(){return getRecordsAsArray().filter(function(e){return!e.shared})}function getSharedFolderById(e){var r=bg.getCacheProp(`shared_folders.${e}`),d=bg.getCacheProp(`shared_folder_meta_data.${e}`);if(r&&d)return Object.assign({},d,r);if(r){var o=!1;return r.teams.forEach(function(e){o||(bg.setCacheProp("shared_folder_meta_data",e),o=e.manage_records&&e.manage_data)}),Object.assign({},bg.getCacheProp("shared_folder_meta_data"),r)}return null}function getSharedFoldersAsArray(){var e=[];if(bg.get("uname")in bg.getCache()){var r=bg.getCacheProp("shared_folders");for(var d in r)e.push(getSharedFolderById(d))}return e}function addRecordToCache(e){bg.getCacheProp(`records.${e.record_uid}`)?bg.setCacheProp(`records.${e.record_uid}`,e):(bg.setCacheProp(`records.${e.record_uid}`,e),bg.setCacheProp(`record_meta_data.${e.record_uid}`,{can_edit:!0,can_share:!0,record_key:e.record_key,record_key_type:1})),updateCachedRecordArray()}function updateCachedRecordArray(){bg.setCacheProp("records_array",[]);var e=bg.getCacheProp("records"),r=bg.getCacheProp("records_array");for(var d in e)r.push(getRecordById(d));bg.setCacheProp("records_array",r)}function updateCachedProfileArrays(){var e=bg.getCacheProp("profile"),r={},d={},o={};"phone"in e&&(e.phone.forEach(function(e){r[e.uid]=e}),bg.setCacheProp("phones",r)),"addresses"in e&&(e.addresses.forEach(function(e){d[e.uid]=e}),bg.setCacheProp("addresses",d)),"cards"in e&&(e.cards.forEach(function(e){o[e.uid]=e}),bg.setCacheProp("cards",o))}function getSyncRevision(){var e=bg.getCache();return e?e.revision:0}function clearUserCache(){bg.delete("cache")}